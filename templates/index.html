<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriere Audio/Video - Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #e53e3e;
            --warning: #ed8936;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; line-height: 1.5; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        header p { color: var(--text-light); }
        
        .system-stats { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
        .stat-item { background: white; padding: 8px 16px; border-radius: 50px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; font-size: 0.85rem; border: 1px solid var(--border); }
        .stat-item i { color: var(--primary); }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .card h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: #4a5568; font-size: 1.1rem; }

        /* Upload Area */
        .upload-zone { border: 2px dashed var(--primary); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f0f4ff; position: relative; }
        .upload-zone:hover { background: #e8ebff; border-color: var(--secondary); }
        .upload-zone i { font-size: 3rem; color: var(--primary); margin-bottom: 15px; }
        .upload-zone p { font-weight: 600; color: var(--primary-dark); }

        /* Settings */
        .settings-group { margin-bottom: 18px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 6px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: white; font-size: 0.95rem; color: var(--text); appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23718096'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; }

        /* Progress */
        .progress-area { margin-top: 20px; display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .progress-bar { height: 10px; background: #edf2f7; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.4s; }
        .progress-status { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; }

        /* Results & Editor */
        .results-section { display: none; margin-top: 40px; animation: fadeIn 0.6s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .editor-container { display: grid; grid-template-columns: 1.2fr 1fr; gap: 30px; }
        @media (max-width: 1100px) { .editor-container { grid-template-columns: 1fr; } }

        .video-container { position: sticky; top: 20px; }
        .video-wrapper { background: #000; border-radius: 12px; overflow: hidden; position: relative; aspect-ratio: 16/9; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        video { width: 100%; height: 100%; }
        
        #subtitleOverlay { position: absolute; bottom: 10%; width: 100%; text-align: center; pointer-events: none; z-index: 10; padding: 0 20px; }
        #currentSubtitle { display: inline-block; background: rgba(0,0,0,0.75); color: white; padding: 6px 16px; border-radius: 6px; font-size: 1.25rem; max-width: 90%; line-height: 1.4; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .segments-list { height: 650px; overflow-y: auto; padding-right: 10px; }
        .segments-list::-webkit-scrollbar { width: 6px; }
        .segments-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .segment-item { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative; }
        .segment-item:hover { border-color: var(--primary); transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .segment-item.active { border-left: 5px solid var(--primary); background: #f0f4ff; }
        
        .segment-meta { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-light); margin-bottom: 8px; font-family: 'Monaco', 'Consolas', monospace; }
        .segment-text { font-size: 0.95rem; color: var(--text); outline: none; min-height: 1.4em; }
        .segment-text:focus { background: #fff; box-shadow: 0 0 0 2px var(--primary); border-radius: 4px; padding: 2px; }
        
        .dual-text { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 5px; }
        .orig-text { color: var(--text-light); font-style: italic; font-size: 0.85rem; border-right: 1px solid var(--border); padding-right: 10px; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: #f8fafc; border-color: var(--primary); }

        .fab-save { position: fixed; bottom: 30px; right: 30px; background: var(--success); color: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 100; cursor: pointer; display: none; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100px); } to { transform: translateY(0); } }
        
        #errorArea { background: #fff5f5; color: #c53030; padding: 15px; border-radius: 10px; margin-bottom: 25px; display: none; border-left: 5px solid var(--danger); font-size: 0.9rem; }

        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-closed-captioning"></i> AI Subtitle Studio</h1>
            <p>Sistem profesional de transcriere și traducere automatizată</p>
        </header>

        <div class="system-stats">
            <div class="stat-item"><i class="fas fa-microchip"></i> <span id="cpuLoad">CPU: --%</span></div>
            <div class="stat-item"><i class="fas fa-memory"></i> <span id="ramUsage">RAM: --%</span></div>
            <div class="stat-item" id="serverHeartbeat"><i class="fas fa-server"></i> <span id="serverStatus">Server: Online</span></div>
        </div>

        <div id="errorArea"></div>

        <div class="main-grid" id="setupGrid">
            <!-- Upload Card -->
            <div class="card">
                <h3><i class="fas fa-cloud-upload-alt"></i> 1. Încărcare Media</h3>
                <div class="upload-zone" id="dropZone">
                    <i class="fas fa-file-video"></i>
                    <p id="uploadText">Trage fișierul aici sau click pentru selectare</p>
                    <span style="font-size: 0.75rem; color: var(--text-light)">MP4, MXF, MOV, AVI, MP3, WAV (Max 50GB)</span>
                    <input type="file" id="fileInput" style="display: none">
                </div>
                <div id="fileDetails" style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 8px; font-size: 0.85rem; display: none;">
                    <div style="display: flex; justify-content: space-between; font-weight: 600;">
                        <span id="fileName" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;"></span>
                        <span id="fileSize"></span>
                    </div>
                </div>
            </div>

            <!-- Settings Card -->
            <div class="card">
                <h3><i class="fas fa-cog"></i> 2. Configurare</h3>
                <div class="settings-group">
                    <label>Model Inteligență Artificială</label>
                    <select id="modelSelect">
                        <option value="tiny">Tiny (Rapid)</option>
                        <option value="base">Base (Echilibrat)</option>
                        <option value="small" selected>Small (Recomandat)</option>
                        <option value="medium">Medium (Calitate Înaltă)</option>
                        <option value="large-v3">Large v3 (Maximă Precizie)</option>
                    </select>
                </div>
                <div class="settings-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>Limbă Sursă</label>
                        <select id="languageSelect">
                            <option value="auto">Auto-detectare</option>
                            <option value="ro">Română</option>
                            <option value="en">Engleză</option>
                            <option value="sk">Slovacă</option>
                            <option value="sl">Slovenă</option>
                            <option value="hu">Maghiară</option>
                            <option value="fr">Franceză</option>
                            <option value="de">Germană</option>
                            <option value="it">Italiană</option>
                            <option value="es">Spaniolă</option>
                        </select>
                    </div>
                    <div>
                        <label>Traducere În</label>
                        <select id="translationSelect">
                            <option value="">-- Fără --</option>
                            <option value="ro">Română</option>
                            <option value="en">Engleză</option>
                            <option value="sk">Slovacă</option>
                            <option value="sl">Slovenă</option>
                            <option value="fr">Franceză</option>
                            <option value="de">Germană</option>
                        </select>
                    </div>
                </div>
                <button id="processBtn" class="btn btn-primary" style="width: 100%; height: 50px; font-size: 1rem;" disabled>
                    <i class="fas fa-rocket"></i> LANSEAZĂ PROCESAREA
                </button>
            </div>
        </div>

        <div class="progress-area" id="progressArea">
            <div class="progress-status">
                <span id="statusText" class="loading-dots">Se inițializează</span>
                <span id="statusPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <p id="etaText" style="font-size: 0.75rem; color: var(--text-light)"></p>
                <button id="cancelTaskBtn" style="background: none; border: none; color: var(--danger); font-size: 0.75rem; cursor: pointer; text-decoration: underline;">Anulează</button>
            </div>
        </div>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h2><i class="fas fa-file-invoice"></i> Rezultate Procesare</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="downloadSRT('original')"><i class="fas fa-download"></i> SRT Original</button>
                    <button class="btn btn-primary" id="downloadTransBtn" onclick="downloadSRT('translated')" style="display: none;"><i class="fas fa-language"></i> SRT Tradus</button>
                    <button class="btn btn-outline" onclick="location.reload()"><i class="fas fa-redo"></i> Nou</button>
                </div>
            </div>

            <div class="editor-container">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoPreview" controls></video>
                        <div id="subtitleOverlay"><p id="currentSubtitle"></p></div>
                    </div>
                    <div class="card" style="margin-top: 20px; padding: 15px;">
                        <h4 style="font-size: 0.9rem; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Sfaturi Editor</h4>
                        <ul style="font-size: 0.8rem; color: var(--text-light); padding-left: 20px;">
                            <li>Modifică textul direct în lista din dreapta.</li>
                            <li>Apasă pe un segment pentru a naviga în video.</li>
                            <li>Modificările se salvează pe server când apeși butonul verde.</li>
                        </ul>
                    </div>
                </div>

                <div class="editor-main">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3><i class="fas fa-list"></i> Segmente (<span id="segmentCount">0</span>)</h3>
                        <div id="editorControls" style="display: flex; gap: 8px;">
                             <button class="btn btn-outline" style="padding: 5px 10px; font-size: 0.75rem;" onclick="toggleTranslationView()" id="toggleTransViewBtn" style="display: none;">
                                <i class="fas fa-columns"></i> Vedere Duală
                             </button>
                        </div>
                    </div>
                    <div class="segments-list" id="segmentsList">
                        <!-- Segments generated here -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div class="fab-save" id="saveFab" onclick="saveManualEdits()">
        <i class="fas fa-save"></i> SALVEAZĂ MODIFICĂRILE
    </div>

    <script>
        let selectedFile = null;
        let processId = null;
        let currentSegments = [];
        let isTranslated = false;
        let targetLanguage = '';
        let pollingInterval = null;
        let showDualView = false;

        // UI Setup
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const progressArea = document.getElementById('progressArea');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        const statusPercent = document.getElementById('statusPercent');
        const resultsSection = document.getElementById('resultsSection');
        const segmentsList = document.getElementById('segmentsList');
        const videoPreview = document.getElementById('videoPreview');
        const currentSubtitle = document.getElementById('currentSubtitle');
        const saveFab = document.getElementById('saveFab');
        const errorArea = document.getElementById('errorArea');

        // Drag & Drop Handling
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = '#e8ebff'; };
        dropZone.ondragleave = () => { dropZone.style.background = '#f0f4ff'; };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
        };

        fileInput.onchange = (e) => {
            if (e.target.files.length) handleFileSelect(e.target.files[0]);
        };

        function handleFileSelect(file) {
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / (1024*1024)).toFixed(1) + ' MB';
            document.getElementById('fileDetails').style.display = 'block';
            document.getElementById('uploadText').innerHTML = 'Gata de trimis: <br>' + file.name;
            processBtn.disabled = false;
            hideError();
        }

        // Logic
        processBtn.onclick = async () => {
            if (!selectedFile) return;
            
            processBtn.disabled = true;
            document.getElementById('setupGrid').style.opacity = '0.5';
            document.getElementById('setupGrid').style.pointerEvents = 'none';
            progressArea.style.display = 'block';
            hideError();

            try {
                // 1. Init
                const initRes = await fetch('/api/chunk_upload/init', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_name: selectedFile.name,
                        file_size: selectedFile.size,
                        total_chunks: Math.ceil(selectedFile.size / (10 * 1024 * 1024)) // 10MB chunk size
                    })
                });
                const { sessionId, totalChunks, chunkSize } = await initRes.json();

                // 2. Upload
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, selectedFile.size);
                    const chunk = selectedFile.slice(start, end);
                    
                    const formData = new FormData();
                    formData.append('chunk', chunk);
                    formData.append('chunkNumber', i);
                    formData.append('totalChunks', totalChunks);
                    
                    statusText.textContent = `Upload: ${i+1}/${totalChunks}`;
                    statusPercent.textContent = Math.round((i+1)/totalChunks * 100) + '%';
                    progressFill.style.width = Math.round((i+1)/totalChunks * 50) + '%'; // 50% for upload

                    await fetch(`/api/chunk_upload/upload?sessionId=${sessionId}`, {
                        method: 'POST',
                        body: formData
                    });
                }

                // 3. Process
                const procRes = await fetch(`/api/chunk_upload/process/${sessionId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        model: document.getElementById('modelSelect').value,
                        language: document.getElementById('languageSelect').value,
                        translation_target: document.getElementById('translationSelect').value,
                        adjust_segmentation: true
                    })
                });
                const procData = await procRes.json();
                processId = procData.process_id;
                
                startPolling();

            } catch (err) {
                showError("Eroare: " + err.message);
                resetUI();
            }
        };

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/task_status/${processId}`);
                    if (res.status === 404) return;
                    const data = await res.json();

                    statusText.textContent = data.message || 'Procesare AI...';
                    statusPercent.textContent = data.progress + '%';
                    progressFill.style.width = (50 + data.progress / 2) + '%';

                    if (data.status === 'completed') {
                        clearInterval(pollingInterval);
                        displayResults(data.result);
                    } else if (data.status === 'error') {
                        clearInterval(pollingInterval);
                        showError(data.message);
                        resetUI();
                    }
                } catch (e) { console.error("Poll error", e); }
            }, 2500);
        }

        function displayResults(result) {
            progressArea.style.display = 'none';
            resultsSection.style.display = 'block';
            document.getElementById('setupGrid').style.display = 'none';
            
            if (result.video_preview_url) {
                videoPreview.src = result.video_preview_url;
                videoPreview.load();
            } else if (result.image_preview_url) {
                // Fallback or image
            }

            isTranslated = result.is_translated;
            targetLanguage = result.target_language;
            currentSegments = result.segments;
            
            if (isTranslated) {
                document.getElementById('downloadTransBtn').style.display = 'flex';
                document.getElementById('toggleTransViewBtn').style.display = 'flex';
            }

            document.getElementById('segmentCount').textContent = currentSegments.length;
            renderSegments();
        }

        function renderSegments() {
            segmentsList.innerHTML = '';
            currentSegments.forEach((seg, idx) => {
                const item = document.createElement('div');
                item.className = 'segment-item';
                item.onclick = () => { videoPreview.currentTime = seg.start; videoPreview.play(); };

                const meta = document.createElement('div');
                meta.className = 'segment-meta';
                meta.innerHTML = `<span>#${idx + 1}</span> <span>${formatTime(seg.start)} → ${formatTime(seg.end)}</span>`;

                const text = document.createElement('div');
                text.className = 'segment-text';
                text.contentEditable = true;
                text.textContent = seg.text;
                text.oninput = () => { seg.text = text.textContent; saveFab.style.display = 'block'; };

                item.appendChild(meta);
                item.appendChild(text);
                segmentsList.appendChild(item);
            });
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        videoPreview.ontimeupdate = () => {
            const time = videoPreview.currentTime;
            const active = currentSegments.find(s => time >= s.start && time <= s.end);
            if (active) {
                currentSubtitle.textContent = active.text;
                const items = document.querySelectorAll('.segment-item');
                items.forEach(el => el.classList.remove('active'));
                const index = currentSegments.indexOf(active);
                if (items[index]) {
                    items[index].classList.add('active');
                    if (!itemInView(items[index])) items[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                currentSubtitle.textContent = '';
            }
        };

        function itemInView(el) {
            const rect = el.getBoundingClientRect();
            const parentRect = segmentsList.getBoundingClientRect();
            return (rect.top >= parentRect.top && rect.bottom <= parentRect.bottom);
        }

        async function saveManualEdits() {
            saveFab.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVARE...';
            try {
                const res = await fetch('/api/save_edits', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        process_id: processId,
                        segments: currentSegments,
                        is_translated: isTranslated,
                        target_lang: targetLanguage
                    })
                });
                if (res.ok) {
                    saveFab.style.display = 'none';
                    saveFab.innerHTML = '<i class="fas fa-save"></i> SALVEAZĂ MODIFICĂRILE';
                }
            } catch (e) { alert('Eroare la salvare'); }
        }

        function downloadSRT(type) {
            let filename = `transcription_${processId}.srt`;
            if (type === 'translated' && isTranslated) {
                filename = `transcription_${processId}_${targetLanguage}.srt`;
            }
            window.location.href = `/download/${processId}/${filename}`;
        }

        function resetUI() {
            processBtn.disabled = false;
            document.getElementById('setupGrid').style.opacity = '1';
            document.getElementById('setupGrid').style.pointerEvents = 'all';
            progressArea.style.display = 'none';
        }

        function showError(msg) {
            errorArea.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${msg}`;
            errorArea.style.display = 'block';
            window.scrollTo(0, 0);
        }
        function hideError() { errorArea.style.display = 'none'; }

        // Stats Polling
        setInterval(async () => {
            try {
                const res = await fetch('/system_info');
                const data = await res.json();
                document.getElementById('cpuLoad').textContent = `CPU: ${data.cpu_usage}%`;
                document.getElementById('ramUsage').textContent = `RAM: ${data.memory_usage}%`;
            } catch(e){}
        }, 5000);

        document.getElementById('cancelTaskBtn').onclick = async () => {
            if (!processId) return;
            await fetch(`/api/cancel_task/${processId}`, { method: 'POST' });
            location.reload();
        };
    </script>
</body>
</html>
