<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriere Video/Audio în SRT cu Upload Segmentat</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1400px;
            padding: 30px;
            margin: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 2.2em;
            font-weight: 300;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1em;
        }
        
        /* Upload Method Selector */
        .upload-method-selector {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #90cdf4;
        }
        
        .method-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .method-btn {
            flex: 1;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .method-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .method-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .method-icon {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .method-name {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 5px;
        }
        
        .method-desc {
            color: #718096;
            font-size: 0.85em;
        }
        
        /* Chunked Upload Progress */
        .chunked-upload-progress {
            display: none;
            margin: 20px 0;
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }
        
        .upload-progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            width: 0%;
            transition: width 0.3s;
        }
        
        .upload-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #4a5568;
            font-weight: bold;
            font-size: 1em;
        }
        
        .chunk-status {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .chunk-indicator {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: #e2e8f0;
            border: 1px solid #cbd5e0;
        }
        
        .chunk-indicator.uploaded {
            background: #48bb78;
            border-color: #38a169;
        }
        
        .chunk-indicator.processing {
            background: #4299e1;
            border-color: #3182ce;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* File Size Warning */
        .size-warning {
            background: #fffaf0;
            border-radius: 10px;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #d69e2e;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .size-warning i {
            color: #d69e2e;
            margin-right: 8px;
        }
        
        .size-warning strong {
            color: #744210;
        }
        
        /* Fallback Options */
        .fallback-options {
            background: #fed7d7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #e53e3e;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .fallback-options h4 {
            color: #742a2a;
            margin-bottom: 10px;
        }
        
        .fallback-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Translation Panel */
        .translation-panel {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #90cdf4;
            animation: fadeIn 0.5s;
        }
        
        .translation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .translation-header h3 {
            color: #2b6cb0;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        
        .translation-toggle {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .translation-toggle:hover {
            background: #3182ce;
        }
        
        .translation-toggle.active {
            background: #2b6cb0;
        }
        
        .translation-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .translation-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .translation-selector label {
            color: #2b6cb0;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .translation-status {
            background: #c6f6d5;
            color: #22543d;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .translation-status.active {
            display: flex;
        }
        
        .translation-status.translating {
            background: #fefcbf;
            color: #744210;
        }
        
        /* Model Selector */
        .model-selector {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }
        
        .model-selector h3 {
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .model-selector h3 i {
            color: #667eea;
        }
        
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .model-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .model-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .model-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .model-name {
            font-weight: bold;
            color: #4a5568;
            font-size: 1.em;
            margin-bottom: 5px;
        }
        
        .model-size {
            color: #718096;
            font-size: 0.85em;
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 6px;
        }
        
        .model-desc {
            color: #4a5568;
            font-size: 0.85em;
            line-height: 1.3;
        }
        
        .model-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        
        .model-status.loaded {
            background: #48bb78;
        }
        
        /* Settings Panel */
        .settings-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .settings-card {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }
        
        .settings-card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
        }
        
        .language-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        select {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #4a5568;
            font-size: 0.95em;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        select:hover, select:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .segmentation-controls {
            margin-top: 15px;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #4a5568;
            font-size: 0.9em;
        }
        
        .control-value {
            color: #667eea;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            color: #4a5568;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }
        
        .upload-area.highlight {
            background: #e8ebff;
            border-color: #4c51bf;
        }
        
        .upload-icon {
            font-size: 40px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-text {
            font-size: 1em;
            color: #555;
            margin-bottom: 8px;
        }
        
        .file-info {
            color: #888;
            font-size: 0.85em;
        }
        
        /* Format Info */
        .format-info {
            background: #e6fffa;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .format-info i {
            color: #234e52;
            margin-right: 8px;
        }
        
        .format-info span {
            color: #234e52;
            font-size: 0.9em;
        }
        
        /* Video Preview Container */
        .video-preview-container {
            display: none;
            margin-bottom: 20px;
            background: #1a202c;
            border-radius: 12px;
            overflow: hidden;
            animation: fadeIn 0.5s;
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background: #000;
        }
        
        #videoPreview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            display: none;
        }
        
        #imagePreview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            display: none;
        }
        
        .subtitle-overlay {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            font-size: 1.2em;
            line-height: 1.4;
            z-index: 10;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            display: none;
        }
        
        #currentSubtitle {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .subtitle-timestamp {
            font-size: 0.8em;
            color: #a0aec0;
            opacity: 0.9;
        }
        
        .video-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #2d3748;
            color: white;
        }
        
        .control-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .time-display {
            font-family: monospace;
            font-size: 1em;
            min-width: 80px;
            text-align: center;
        }
        
        .play-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .play-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }
        
        /* Progress bar pentru video */
        .video-progress {
            flex: 1;
            height: 4px;
            background: #4a5568;
            margin: 0 15px;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        
        .video-progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #667eea;
            border-radius: 2px;
            width: 0%;
        }
        
        .video-progress:hover .video-progress-fill {
            background: #764ba2;
        }
        
        /* Segments Preview */
        .segments-preview {
            display: none;
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            animation: fadeIn 0.5s;
        }
        
        .preview-segment {
            background: white;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .preview-segment-header {
            display: flex;
            justify-content: space-between;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        
        .preview-segment-text {
            color: #333;
            line-height: 1.4;
            font-size: 0.95em;
        }
        
        /* Translation UI in segments */
        .segment-translation-toggle {
            background: #4299e1;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .segment-translation-toggle:hover {
            background: #3182ce;
        }
        
        .segment-translation-toggle.active {
            background: #2b6cb0;
        }
        
        .segment-translation {
            margin-top: 8px;
            padding: 10px;
            background: #f0f9ff;
            border-left: 3px solid #4299e1;
            border-radius: 0 5px 5px 0;
            animation: fadeIn 0.3s;
        }
        
        .segment-translation-header {
            display: flex;
            justify-content: space-between;
            color: #2b6cb0;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .segment-translation-text {
            color: #2d3748;
            line-height: 1.4;
        }
        
        /* Language badge */
        .language-badge {
            background: #4299e1;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .language-badge.source {
            background: #38a169;
        }
        
        .language-badge.target {
            background: #d69e2e;
        }
        
        /* Translation progress */
        .translation-progress {
            display: none;
            margin-top: 10px;
        }
        
        .translation-progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .translation-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #2b6cb0);
            width: 0%;
            transition: width 0.3s;
        }
        
        .translation-progress-text {
            text-align: center;
            margin-top: 5px;
            color: #4a5568;
            font-size: 0.85em;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #718096;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .download-btn {
            background: #48bb78;
        }
        
        .download-btn:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #e53e3e;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 15px;
            animation: fadeIn 0.5s;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Results */
        .result-container {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .segments {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
        }
        
        .segment {
            background: #f8f9ff;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }
        
        .segment.highlighted {
            background: #e6fffa !important;
            border-left: 4px solid #48bb78 !important;
        }
        
        .segment-header {
            display: flex;
            justify-content: space-between;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        
        .segment-text {
            color: #333;
            line-height: 1.4;
        }
        
        .full-text {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* System Info */
        .system-info {
            background: #e6fffa;
            border-radius: 10px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.85em;
            color: #234e52;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .info-label {
            font-weight: bold;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9ff;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        /* Errors and Preview */
        .error {
            color: #e53e3e;
            background: #fed7d7;
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        /* Progress Bar */
        .progress-container {
            margin: 15px 0;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: #4a5568;
            font-size: 0.85em;
        }
        
        /* Processing Info */
        .processing-info {
            background: #f0f4ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .info-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-card h4 {
            color: #4a5568;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        
        .info-card p {
            color: #667eea;
            font-weight: bold;
            font-size: 1em;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .toast.success {
            background: #48bb78;
        }
        
        .toast.error {
            background: #e53e3e;
        }
        
        .toast.info {
            background: #667eea;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Manual scroll button */
        .scroll-to-current {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .scroll-to-current:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
        
        /* Multiple Translations Panel */
        .multiple-translations-panel {
            background: #fffaf0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #d69e2e;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .multiple-translations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .multiple-translations-header h3 {
            color: #d69e2e;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        
        .translations-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .translation-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .translation-item:hover {
            border-color: #d69e2e;
            transform: translateY(-2px);
        }
        
        .translation-item.active {
            border-color: #38a169;
            background: #f0fff4;
        }
        
        .translation-lang {
            font-weight: bold;
            color: #2d3748;
        }
        
        .translation-action {
            background: #4299e1;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .translation-action:hover {
            background: #3182ce;
        }
        
        .new-translation-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        .new-translation-controls select {
            flex: 1;
        }
        
        /* Debug button */
        .debug-btn {
            background: #805ad5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .debug-btn:hover {
            background: #6b46c1;
        }
        
        /* Resume Upload Button */
        .resume-upload {
            background: #d69e2e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .resume-upload:hover {
            background: #b7791f;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .settings-panel {
                grid-template-columns: 1fr;
            }
            
            .model-grid {
                grid-template-columns: 1fr;
            }
            
            .method-buttons {
                flex-direction: column;
            }
            
            .upload-stats {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .video-controls {
                flex-wrap: wrap;
            }
            
            .time-display {
                font-size: 0.9em;
                min-width: 70px;
            }
            
            .play-btn {
                padding: 6px 15px;
                font-size: 0.9em;
            }
            
            .translation-controls {
                grid-template-columns: 1fr;
            }
            
            .multiple-translations-panel {
                padding: 15px;
            }
            
            .translations-list {
                flex-direction: column;
            }
            
            .new-translation-controls {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-closed-captioning"></i> Transcriere Video/Audio cu Upload Segmentat</h1>
        <p class="subtitle">Suportă fișiere mari până la 50GB • Upload în bucăți • Procesare optimizată</p>
        
        <!-- System Info -->
        <div class="system-info" id="systemInfo">
            <div class="info-item">
                <i class="fas fa-microchip"></i>
                <span id="deviceInfo">Se încarcă...</span>
            </div>
            <div class="info-item">
                <i class="fas fa-hdd"></i>
                <span id="memoryInfo">Se încarcă...</span>
            </div>
            <div class="info-item">
                <i class="fas fa-upload"></i>
                <span id="uploadInfo">Max: 50GB • Chunk: 10MB</span>
            </div>
            <div class="info-item">
                <i class="fas fa-clock"></i>
                <span id="timeoutInfo">Timeout: 2 ore</span>
            </div>
        </div>
        
        <!-- Upload Method Selector -->
        <div class="upload-method-selector">
            <h3><i class="fas fa-upload"></i> Selectează Metoda de Upload</h3>
            <div class="method-buttons">
                <div class="method-btn active" id="simpleUploadBtn" onclick="selectUploadMethod('simple')">
                    <div class="method-icon"><i class="fas fa-bolt"></i></div>
                    <div class="method-name">Upload Simplu</div>
                    <div class="method-desc">Pentru fișiere mici (&lt;500MB)</div>
                </div>
                <div class="method-btn" id="chunkedUploadBtn" onclick="selectUploadMethod('chunked')">
                    <div class="method-icon"><i class="fas fa-layer-group"></i></div>
                    <div class="method-name">Upload Segmentat</div>
                    <div class="method-desc">Pentru fișiere mari (până la 50GB)</div>
                </div>
            </div>
        </div>
        
        <!-- Chunked Upload Progress -->
        <div class="chunked-upload-progress" id="chunkedUploadProgress">
            <h3><i class="fas fa-tasks"></i> Progres Upload Segmentat</h3>
            
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="uploadProgressFill"></div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                <div>
                    <strong id="uploadFileName">-</strong>
                    <div style="font-size: 0.85em; color: #718096;">
                        <span id="uploadedSize">0 MB</span> / <span id="totalSize">0 MB</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold; font-size: 1.2em;" id="uploadPercentage">0%</div>
                    <div style="font-size: 0.85em; color: #718096;" id="uploadSpeed">-</div>
                </div>
            </div>
            
            <div class="upload-stats">
                <div class="stat-item">
                    <div class="stat-label">Chunks procesate</div>
                    <div class="stat-value" id="chunksProcessed">0/0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Timp estimat</div>
                    <div class="stat-value" id="estimatedTime">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Viteză medie</div>
                    <div class="stat-value" id="averageSpeed">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Status</div>
                    <div class="stat-value" id="uploadStatus">În așteptare</div>
                </div>
            </div>
            
            <div class="chunk-status" id="chunkStatus">
                <!-- Chunk indicators will be added here -->
            </div>
            
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="pauseUpload()" id="pauseUploadBtn">
                    <i class="fas fa-pause"></i> Pauză
                </button>
                <button class="btn btn-danger" onclick="cancelUpload()" id="cancelUploadBtn">
                    <i class="fas fa-times"></i> Anulează
                </button>
                <button class="btn resume-upload" onclick="resumeUpload()" id="resumeUploadBtn" style="display: none;">
                    <i class="fas fa-play"></i> Reluare
                </button>
            </div>
        </div>
        
        <!-- File Size Warning -->
        <div class="size-warning" id="sizeWarning">
            <i class="fas fa-exclamation-triangle"></i>
            <span><strong>Fișier mare detectat!</strong> Pentru o experiență optimă, se recomandă <strong>Upload Segmentat</strong>.</span>
        </div>
        
        <!-- Fallback Options -->
        <div class="fallback-options" id="fallbackOptions">
            <h4><i class="fas fa-exclamation-circle"></i> Fișier prea mare pentru upload simplu</h4>
            <p>Fișierul tău depășește limita de 500MB pentru upload simplu. Alege una dintre opțiuni:</p>
            <div class="fallback-buttons">
                <button class="btn" onclick="switchToChunkedUpload()">
                    <i class="fas fa-layer-group"></i> Folosește Upload Segmentat
                </button>
                <button class="btn btn-secondary" onclick="extractAudioOnly()">
                    <i class="fas fa-volume-up"></i> Extrage doar Audio
                </button>
            </div>
        </div>
        
        <!-- Translation Panel -->
        <div class="translation-panel" id="translationPanel">
            <div class="translation-header">
                <h3><i class="fas fa-language"></i> Traducere Subtitrări</h3>
                <button class="translation-toggle" id="toggleTranslation">
                    <i class="fas fa-toggle-off"></i> Dezactivată
                </button>
            </div>
            
            <div class="translation-controls" id="translationControls" style="display: none;">
                <div class="translation-selector">
                    <label for="translationSelect"><i class="fas fa-globe-americas"></i> Traducere în:</label>
                    <select id="translationSelect">
                        <option value="">-- Selectează limba țintă --</option>
                        <!-- Languages will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="translation-status" id="translationStatus">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <span>Se încarcă modelele de traducere...</span>
                </div>
            </div>
            
            <div class="translation-progress" id="translationProgress">
                <div class="translation-progress-bar">
                    <div class="translation-progress-fill" id="translationProgressFill"></div>
                </div>
                <div class="translation-progress-text" id="translationProgressText"></div>
            </div>
        </div>
        
        <!-- Settings Panel -->
        <div class="settings-panel">
            <!-- Model Selection -->
            <div class="settings-card">
                <h3><i class="fas fa-brain"></i> Selectare Model Whisper</h3>
                <div class="model-grid" id="modelGrid">
                    <!-- Models will be loaded here -->
                </div>
            </div>
            
            <!-- Language & Segmentation -->
            <div class="settings-card">
                <h3><i class="fas fa-language"></i> Setări Limbă și Segmentare</h3>
                
                <div class="language-selector">
                    <label for="languageSelect"><i class="fas fa-globe"></i> Limbă:</label>
                    <select id="languageSelect">
                        <option value="auto">Detectare automată</option>
                        <!-- Languages will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="adjustSegmentation" checked>
                    <label for="adjustSegmentation">Ajustare automată segmentare pentru subtitrări</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="extractAudioOnlyCheckbox">
                    <label for="extractAudioOnlyCheckbox">Doar extragere audio (fără transcriere)</label>
                </div>

                <div class="segmentation-controls" id="segmentationControls">
                    <div class="control-group">
                        <label>
                            <span>Durata minimă segment (sec):</span>
                            <span class="control-value" id="minDurationValue">1.0s</span>
                        </label>
                        <input type="range" id="minDuration" min="0.5" max="3.0" step="0.1" value="1.0">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <span>Durata maximă segment (sec):</span>
                            <span class="control-value" id="maxDurationValue">5.0s</span>
                        </label>
                        <input type="range" id="maxDuration" min="3.0" max="10.0" step="0.1" value="5.0">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <span>Caractere maxime pe segment:</span>
                            <span class="control-value" id="maxCharsValue">80</span>
                        </label>
                        <input type="range" id="maxChars" min="40" max="120" step="1" value="80">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div>
                <strong>Setări curente:</strong>
                <span class="status-badge" id="currentModel">small</span>
                <span class="status-badge" id="currentLanguage">auto</span>
                <span class="status-badge" id="uploadMethod">Simplu</span>
                <span class="status-badge" id="translationBadge" style="display: none;">
                    <i class="fas fa-language"></i> Traducere
                </span>
                <span class="status-badge" id="segmentationStatus">Segmentare: ON</span>
                <button class="debug-btn" onclick="debugInfo()" title="Info debugging">
                    <i class="fas fa-bug"></i> Debug
                </button>
            </div>
            <div class="formats">
                <span style="color: #718096; font-size: 0.85em;">
                    Formate: MP4, AVI, MOV, MKV, MXF, WMV, FLV, MP3, WAV (Max: 50GB)
                </span>
            </div>
        </div>
        
        <!-- Format Info -->
        <div class="format-info" id="formatInfo">
            <i class="fas fa-info-circle"></i>
            <span id="formatInfoText"></span>
        </div>
        
        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon"><i class="fas fa-file-upload"></i></div>
            <div class="upload-text" id="uploadText">Trage și plasează fișierul aici sau click pentru a selecta</div>
            <div class="file-info" id="fileInfo">
                Upload Simplu: &lt;500MB • Upload Segmentat: până la 50GB
            </div>
            <input type="file" class="file-input" id="fileInput" 
                   accept=".mp4,.avi,.mov,.mkv,.m4v,.mp3,.wav,.mpeg,.webm,.mxf,.wmv,.flv">
        </div>
        
        <!-- Video Preview -->
        <div class="video-preview-container" id="videoPreviewContainer">
            <div class="video-wrapper">
                <video id="videoPreview" controls>
                    <source id="videoSource" type="video/mp4">
                    Browser-ul tău nu suportă tag-ul video.
                </video>
                <img id="imagePreview" src="" alt="Image Preview">
                <div class="subtitle-overlay" id="subtitleOverlay">
                    <div id="currentSubtitle"></div>
                    <div class="subtitle-timestamp" id="subtitleTimestamp"></div>
                </div>
            </div>
            <div class="video-controls">
                <div class="time-display" id="currentTime">00:00:00</div>
                <button class="play-btn" id="playVideoBtn">
                    <i class="fas fa-play"></i> Play cu Subtitrări
                </button>
                <div class="time-display" id="totalTime">00:00:00</div>
            </div>
        </div>
        
        <!-- Quick Preview Segments -->
        <div class="segments-preview" id="segmentsPreview">
            <h3><i class="fas fa-eye"></i> Previzualizare Transcriere</h3>
            <div id="previewContent"></div>
        </div>
        
        <!-- Multiple Translations Panel -->
        <div class="multiple-translations-panel" id="multipleTranslationsPanel">
            <div class="multiple-translations-header">
                <h3><i class="fas fa-globe-europe"></i> Traduceri Multiplă</h3>
                <button class="translation-action" onclick="refreshTranslationsList()">
                    <i class="fas fa-sync-alt"></i> Actualizează
                </button>
            </div>
            
            <div id="translationsListContainer">
                <p>Se încarcă traducerile existente...</p>
            </div>
            
            <div class="new-translation-controls">
                <select id="newTranslationSelect">
                    <option value="">-- Alege o limbă nouă --</option>
                    <!-- Languages will be populated by JavaScript -->
                </select>
                <button class="btn" onclick="addNewTranslation()" id="addTranslationBtn">
                    <i class="fas fa-plus"></i> Adaugă Traducere
                </button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Se procesează...</div>
        </div>
        
        <!-- Error Message -->
        <div class="error" id="errorArea"></div>
        
        <!-- Button Group -->
        <div class="button-group">
            <button class="btn" id="processBtn" onclick="processFile()" disabled>
                <i class="fas fa-play"></i> Start Transcriere
            </button>
            <button class="btn btn-secondary" id="quickPreviewBtn" onclick="quickPreview()" disabled>
                <i class="fas fa-eye"></i> Previzualizare Rapidă
            </button>
            <button class="btn btn-danger" onclick="resetApp()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
        
        <!-- Processing Info -->
        <div class="processing-info" id="processingInfo">
            <h3><i class="fas fa-info-circle"></i> Informații procesare:</h3>
            <div class="info-grid">
                <div class="info-card">
                    <h4>Model folosit</h4>
                    <p id="infoModel">-</p>
                </div>
                <div class="info-card">
                    <h4>Timp procesare</h4>
                    <p id="infoTime">-</p>
                </div>
                <div class="info-card">
                    <h4>Limbă detectată</h4>
                    <p id="infoLanguage">-</p>
                </div>
                <div class="info-card">
                    <h4>Traducere</h4>
                    <p id="infoTranslation">-</p>
                </div>
            </div>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Se procesează... Vă rugăm să așteptați.</p>
            <p id="loadingTranslationInfo" style="display: none;">
                <i class="fas fa-language"></i> Traducerea poate dura mai mult pentru fișiere mari.
            </p>
            <p id="processingChunksInfo" style="display: none; color: #4299e1;">
                <i class="fas fa-layer-group"></i> Se procesează în chunks pentru optimizare...
            </p>
        </div>
        
        <!-- Results -->
        <div class="result-container" id="resultContainer">
            <h2 id="resultTitle"><i class="fas fa-check-circle"></i> Transcriere finalizată!</h2>

            <div id="audioOnlyResult" style="display: none; text-align: center; margin: 20px 0;">
                <div class="info-card" style="display: inline-block; margin-bottom: 20px;">
                    <p><i class="fas fa-volume-up"></i> Audio-ul a fost extras cu succes. Fișierul video original a fost șters pentru a economisi spațiu.</p>
                </div>
                <div class="button-group">
                    <a id="audioDownloadLink" href="#" class="btn download-btn">
                        <i class="fas fa-download"></i> Descarcă Audio (MP3)
                    </a>
                </div>
            </div>

            <div id="transcriptionResult">
                <!-- Translation Toggle in Results -->
            <div style="margin: 15px 0; display: flex; justify-content: center; gap: 10px;">
                <button class="segment-translation-toggle" id="toggleSegmentsTranslation" onclick="toggleSegmentsTranslation()">
                    <i class="fas fa-language"></i> Afișează Traducerea
                </button>
                <button class="segment-translation-toggle" onclick="showMultipleTranslations()" id="showMultipleTranslationsBtn">
                    <i class="fas fa-globe-europe"></i> Traduceri Multiplă
                </button>
                <button class="segment-translation-toggle" onclick="downloadTranslatedSRT()" id="downloadTranslatedBtn" style="display: none;">
                    <i class="fas fa-download"></i> Descarcă SRT Tradus
                </button>
            </div>
            
            <div class="full-text" id="fullText"></div>
            
            <h3><i class="fas fa-list"></i> Segmente cu timecode:</h3>
            <div class="segments" id="segmentsList"></div>
            
            <div id="transcriptionButtons" class="button-group">
                <button class="btn" id="saveEditsBtn" onclick="saveEdits()" style="background: #805ad5;">
                    <i class="fas fa-save"></i> Salvează Modificările
                </button>
                <button class="btn download-btn" onclick="downloadSRT()">
                    <i class="fas fa-download"></i> Descarcă Fișier SRT
                </button>
                <button class="btn download-btn" onclick="downloadTranslatedSRT()" id="mainDownloadTranslatedBtn" style="display: none;">
                    <i class="fas fa-language"></i> Descarcă SRT Tradus
                </button>
                <button class="btn btn-secondary" onclick="playWithSubtitles()" id="playWithSubtitlesBtn">
                    <i class="fas fa-film"></i> Play cu Subtitrări
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scroll to Current Button -->
    <button class="scroll-to-current" id="scrollToCurrentBtn" onclick="scrollToCurrentSegment()" title="Scroll la subtitrarea curentă">
        <i class="fas fa-arrow-down"></i>
    </button>
    
    <script>
        // Variabile globale
        let selectedFile = null;
        let srtFilename = '';
        let translatedSrtFilename = '';
        let currentModel = '{{ selected_model }}';
        let currentLanguage = '{{ selected_language }}';
        let translationTarget = '{{ translation_target }}' !== 'None' ? '{{ translation_target }}' : null;
        let segmentationSettings = {{ segmentation_settings|tojson }};
        let modelsStatus = {};
        let currentSegments = [];
        let originalSegments = [];
        let translatedSegments = [];
        let videoPreviewUrl = null;
        let imagePreviewUrl = null;
        let processId = null;
        let isVideoFile = false;
        let isMp4File = false;
        let videoDuration = 0;
        let previewSegments = [];
        let videoPlaying = false;
        let currentSegmentIndex = -1;
        let videoPlayInterval = null;
        let translationEnabled = false;
        let showTranslatedSegments = false;
        let translationCapabilities = [];
        let multipleTranslations = {};
        let currentTranslationLang = null;
        
        // Variabile pentru upload segmentat
        let uploadMethod = 'simple'; // 'simple' sau 'chunked'
        let chunkedUploadSession = null;
        let uploadStartTime = null;
        let uploadPaused = false;
        let uploadCancelled = false;
        let totalChunks = 0;
        let uploadedChunks = 0;
        let chunkSize = 10 * 1024 * 1024; // 10MB
        let maxSimpleSize = 500 * 1024 * 1024; // 500MB
        let maxChunkedSize = 50 * 1024 * 1024 * 1024; // 50GB
        
        // Elemente DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadText = document.getElementById('uploadText');
        const processBtn = document.getElementById('processBtn');
        const quickPreviewBtn = document.getElementById('quickPreviewBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const errorArea = document.getElementById('errorArea');
        const currentModelElement = document.getElementById('currentModel');
        const currentLanguageElement = document.getElementById('currentLanguage');
        const uploadMethodElement = document.getElementById('uploadMethod');
        const translationBadge = document.getElementById('translationBadge');
        const segmentationStatusElement = document.getElementById('segmentationStatus');
        const modelGrid = document.getElementById('modelGrid');
        const languageSelect = document.getElementById('languageSelect');
        const adjustSegmentationCheckbox = document.getElementById('adjustSegmentation');
        const extractAudioOnlyCheckbox = document.getElementById('extractAudioOnlyCheckbox');
        const segmentationControls = document.getElementById('segmentationControls');
        const minDurationSlider = document.getElementById('minDuration');
        const maxDurationSlider = document.getElementById('maxDuration');
        const maxCharsSlider = document.getElementById('maxChars');
        const minDurationValue = document.getElementById('minDurationValue');
        const maxDurationValue = document.getElementById('maxDurationValue');
        const maxCharsValue = document.getElementById('maxCharsValue');
        const videoPreviewContainer = document.getElementById('videoPreviewContainer');
        const videoPreview = document.getElementById('videoPreview');
        const imagePreview = document.getElementById('imagePreview');
        const subtitleOverlay = document.getElementById('subtitleOverlay');
        const currentSubtitle = document.getElementById('currentSubtitle');
        const subtitleTimestamp = document.getElementById('subtitleTimestamp');
        const playVideoBtn = document.getElementById('playVideoBtn');
        const currentTimeElement = document.getElementById('currentTime');
        const totalTimeElement = document.getElementById('totalTime');
        const segmentsPreview = document.getElementById('segmentsPreview');
        const previewContent = document.getElementById('previewContent');
        const systemInfo = document.getElementById('systemInfo');
        const deviceInfo = document.getElementById('deviceInfo');
        const memoryInfo = document.getElementById('memoryInfo');
        const uploadInfo = document.getElementById('uploadInfo');
        const timeoutInfo = document.getElementById('timeoutInfo');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const processingInfo = document.getElementById('processingInfo');
        const infoModel = document.getElementById('infoModel');
        const infoTime = document.getElementById('infoTime');
        const infoLanguage = document.getElementById('infoLanguage');
        const infoTranslation = document.getElementById('infoTranslation');
        const playWithSubtitlesBtn = document.getElementById('playWithSubtitlesBtn');
        const scrollToCurrentBtn = document.getElementById('scrollToCurrentBtn');
        const formatInfo = document.getElementById('formatInfo');
        const formatInfoText = document.getElementById('formatInfoText');
        const translationPanel = document.getElementById('translationPanel');
        const toggleTranslationBtn = document.getElementById('toggleTranslation');
        const translationControls = document.getElementById('translationControls');
        const translationSelect = document.getElementById('translationSelect');
        const translationStatus = document.getElementById('translationStatus');
        const translationProgress = document.getElementById('translationProgress');
        const translationProgressFill = document.getElementById('translationProgressFill');
        const translationProgressText = document.getElementById('translationProgressText');
        const loadingTranslationInfo = document.getElementById('loadingTranslationInfo');
        const processingChunksInfo = document.getElementById('processingChunksInfo');
        const toggleSegmentsTranslationBtn = document.getElementById('toggleSegmentsTranslation');
        const downloadTranslatedBtn = document.getElementById('downloadTranslatedBtn');
        const mainDownloadTranslatedBtn = document.getElementById('mainDownloadTranslatedBtn');
        const multipleTranslationsPanel = document.getElementById('multipleTranslationsPanel');
        const translationsListContainer = document.getElementById('translationsListContainer');
        const newTranslationSelect = document.getElementById('newTranslationSelect');
        const addTranslationBtn = document.getElementById('addTranslationBtn');
        const showMultipleTranslationsBtn = document.getElementById('showMultipleTranslationsBtn');
        const saveEditsBtn = document.getElementById('saveEditsBtn');
        
        // Elemente pentru upload segmentat
        const simpleUploadBtn = document.getElementById('simpleUploadBtn');
        const chunkedUploadBtn = document.getElementById('chunkedUploadBtn');
        const chunkedUploadProgress = document.getElementById('chunkedUploadProgress');
        const uploadProgressFill = document.getElementById('uploadProgressFill');
        const uploadFileName = document.getElementById('uploadFileName');
        const uploadedSize = document.getElementById('uploadedSize');
        const totalSize = document.getElementById('totalSize');
        const uploadPercentage = document.getElementById('uploadPercentage');
        const uploadSpeed = document.getElementById('uploadSpeed');
        const chunksProcessed = document.getElementById('chunksProcessed');
        const estimatedTime = document.getElementById('estimatedTime');
        const averageSpeed = document.getElementById('averageSpeed');
        const uploadStatus = document.getElementById('uploadStatus');
        const chunkStatus = document.getElementById('chunkStatus');
        const pauseUploadBtn = document.getElementById('pauseUploadBtn');
        const cancelUploadBtn = document.getElementById('cancelUploadBtn');
        const resumeUploadBtn = document.getElementById('resumeUploadBtn');
        const sizeWarning = document.getElementById('sizeWarning');
        const fallbackOptions = document.getElementById('fallbackOptions');
        const fileInfo = document.getElementById('fileInfo');
        
        // Inițializare
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentModel();
            updateCurrentLanguage();
            updateUploadMethod();
            updateSegmentationStatus();
            loadModels();
            loadLanguages();
            loadTranslationLanguages();
            loadSystemInfo();
            loadModelStatus();
            
            // Ascultă evenimente pentru controale
            minDurationSlider.addEventListener('input', updateSegmentationSettings);
            maxDurationSlider.addEventListener('input', updateSegmentationSettings);
            maxCharsSlider.addEventListener('input', updateSegmentationSettings);
            adjustSegmentationCheckbox.addEventListener('change', toggleSegmentationControls);
            languageSelect.addEventListener('change', updateLanguage);
            translationSelect.addEventListener('change', updateTranslationTarget);
            toggleTranslationBtn.addEventListener('click', toggleTranslation);
            
            // Inițializează controalele de segmentare
            minDurationSlider.value = segmentationSettings.min_duration;
            maxDurationSlider.value = segmentationSettings.max_duration;
            maxCharsSlider.value = segmentationSettings.max_chars;
            adjustSegmentationCheckbox.checked = segmentationSettings.adjust_segmentation;
            toggleSegmentationControls();
            updateSliderValues();
            
            // Inițializează traducerea
            translationEnabled = translationTarget !== null && translationTarget !== '' && translationTarget !== 'None';
            updateTranslationUI();
            
            // Verifică statusul modelelor periodic
            setInterval(loadModelStatus, 10000);
            
            // Verifică capacitățile de traducere
            checkTranslationCapabilities();
            
            // Încarcă limbile pentru traduceri multiple
            loadNewTranslationLanguages();
            
            // Event listeners pentru video
            videoPreview.addEventListener('timeupdate', function() {
                const currentTime = videoPreview.currentTime;
                currentTimeElement.textContent = formatTime(currentTime);
                updateCurrentSubtitle(currentTime);
            });

            videoPreview.addEventListener('play', function() {
                console.log('Video started playing');
                videoPlaying = true;
                playVideoBtn.innerHTML = '<i class="fas fa-pause"></i> Pauză';
            });

            videoPreview.addEventListener('pause', function() {
                console.log('Video paused');
                videoPlaying = false;
                playVideoBtn.innerHTML = '<i class="fas fa-play"></i> Play cu Subtitrări';
            });

            videoPreview.addEventListener('ended', function() {
                console.log('Video ended');
                stopPlayback();
            });

            videoPreview.addEventListener('error', function(e) {
                console.error('Video element error:', videoPreview.error);
                showToast('Eroare la încărcarea video-ului. Verificați conexiunea tunnel.', 'error');
            });

            // Afișează un mesaj de bun venit
            setTimeout(() => {
                showToast(`Aplicația este gata! Upload: ${uploadMethod === 'simple' ? 'Simplu' : 'Segmentat'}`, 'success');

                // Încearcă să restaurezi starea anterioară dacă există un processId în sesiune
                const savedProcessId = '{{ session.get("process_id", "") }}';
                if (savedProcessId) {
                    processId = savedProcessId;
                    restoreSession(processId);
                }
            }, 1000);
        });

        // Restaurează sesiunea anterioară
        async function restoreSession(pid) {
            try {
                const response = await fetch(`/segments_json/${pid}/original_segments.json`);
                if (!response.ok) return;

                const data = await response.json();
                if (data.segments) {
                    showToast('Se restaurează sesiunea anterioară...', 'info');
                    originalSegments = data.segments;
                    currentSegments = data.segments;
                    processId = pid;

                    // Încearcă să obțină starea completă de la server
                    const statusResp = await fetch('/get_existing_translations');
                    const statusData = await statusResp.json();

                    if (statusData.success) {
                        infoLanguage.textContent = statusData.detected_language;
                        infoModel.textContent = "Restaurat";
                        infoTime.textContent = "-";

                        // Caută fișierul SRT principal
                        if (statusData.translations && statusData.translations.length > 0) {
                            // ...
                        }

                        // Căutăm orice fișier SRT în directorul procesului pentru a activa descărcarea
                        // Deocamdată activăm descărcarea generală
                        srtFilename = "transcription.srt"; // Fallback name

                        displaySegments(originalSegments);
                        resultContainer.style.display = 'block';
                        processingInfo.style.display = 'block';
                        showMultipleTranslationsBtn.style.display = 'inline-flex';

                        // Actualizează lista de traduceri
                        refreshTranslationsList();

                        // Verifică dacă există video pentru preview
                        checkVideoExists(pid);
                    }
                }
            } catch (error) {
                console.error('Eroare la restaurarea sesiunii:', error);
            }
        }

        // Verifică dacă există un fișier video pentru preview
        async function checkVideoExists(pid) {
            try {
                const resp = await fetch(`/check_video/${pid}`);
                const data = await resp.json();
                if (data.success && data.video_url) {
                    videoPreview.src = data.video_url;
                    videoPreview.style.display = 'block';
                    videoPreviewContainer.style.display = 'block';
                    videoDuration = data.duration || 0;
                    totalTimeElement.textContent = formatTime(videoDuration);
                    playWithSubtitlesBtn.style.display = 'inline-flex';
                    showToast('Preview video restaurat', 'success');
                }
            } catch (e) {}
        }
        
        // Selectează metoda de upload
        function selectUploadMethod(method) {
            uploadMethod = method;
            
            if (method === 'simple') {
                simpleUploadBtn.classList.add('active');
                chunkedUploadBtn.classList.remove('active');
                chunkedUploadProgress.style.display = 'none';
                fileInfo.textContent = 'Upload Simplu: <500MB • Upload Segmentat: până la 50GB';
            } else {
                simpleUploadBtn.classList.remove('active');
                chunkedUploadBtn.classList.add('active');
                fileInfo.textContent = 'Upload Segmentat: Chunks de 10MB • Suport până la 50GB';
            }
            
            updateUploadMethod();
            
            // Dacă există deja un fișier selectat, verifică compatibilitatea
            if (selectedFile) {
                checkFileCompatibility();
            }
        }
        
        function updateUploadMethod() {
            uploadMethodElement.textContent = uploadMethod === 'simple' ? 'Simplu' : 'Segmentat';
            uploadMethodElement.title = `Metoda curentă: ${uploadMethod === 'simple' ? 'Upload simplu' : 'Upload segmentat'}`;
        }
        
        // Funcție de debugging
        function debugInfo() {
            console.log('=== DEBUG INFO ===');
            console.log('Upload method:', uploadMethod);
            console.log('Selected file:', selectedFile ? {
                name: selectedFile.name,
                size: formatFileSize(selectedFile.size),
                type: selectedFile.type
            } : 'none');
            console.log('Original segments:', originalSegments ? originalSegments.length : 0);
            console.log('Current segments:', currentSegments ? currentSegments.length : 0);
            console.log('Translated segments:', translatedSegments ? translatedSegments.length : 0);
            console.log('Multiple translations:', Object.keys(multipleTranslations));
            console.log('Detected language:', infoLanguage.textContent);
            console.log('Process ID:', processId);
            console.log('Chunked upload session:', chunkedUploadSession);
            
            showToast('Info debugging afișat în consolă (F12 → Console)', 'info');
        }
        
        // Încarcă modelele disponibile
        async function loadModels() {
            try {
                const response = await fetch('/get_models');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                modelGrid.innerHTML = '';
                data.models.forEach(model => {
                    const isSelected = model.id === currentModel;
                    const modelElement = document.createElement('div');
                    modelElement.className = `model-option ${isSelected ? 'selected' : ''}`;
                    modelElement.innerHTML = `
                        <div class="model-name">${model.name}</div>
                        <div class="model-size">${model.size}</div>
                        <div class="model-desc">${model.description}</div>
                        <div class="model-status ${modelsStatus[model.id]?.loaded ? 'loaded' : ''}" 
                             id="status-${model.id}"></div>
                    `;
                    
                    modelElement.onclick = () => selectModel(model.id);
                    modelGrid.appendChild(modelElement);
                });
            } catch (error) {
                console.error('Eroare la încărcarea modelelor:', error);
                showToast('Eroare la încărcarea modelelor', 'error');
            }
        }
        
        // Încarcă limbile disponibile
        async function loadLanguages() {
            try {
                const response = await fetch('/get_languages');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                languageSelect.innerHTML = '<option value="auto">Detectare automată</option>';
                data.languages.forEach(lang => {
                    if (lang.code !== 'auto') {
                        const option = document.createElement('option');
                        option.value = lang.code;
                        option.textContent = `${lang.name} (${lang.code})`;
                        option.selected = lang.selected;
                        languageSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Eroare la încărcarea limbilor:', error);
            }
        }
        
        // Încarcă limbile pentru traducere
        async function loadTranslationLanguages() {
            try {
                const response = await fetch('/get_translation_languages');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                translationSelect.innerHTML = '<option value="">-- Selectează limba țintă --</option>';
                data.translation_languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang.code;
                    option.textContent = `${lang.name} (${lang.code})`;
                    option.selected = lang.selected;
                    translationSelect.appendChild(option);
                });
                
                if (data.current_target) {
                    translationSelect.value = data.current_target;
                }
            } catch (error) {
                console.error('Eroare la încărcarea limbilor de traducere:', error);
            }
        }
        
        // Încarcă limbile pentru traduceri noi
        async function loadNewTranslationLanguages() {
            try {
                const response = await fetch('/get_translation_languages');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                newTranslationSelect.innerHTML = '<option value="">-- Alege o limbă nouă --</option>';
                data.translation_languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang.code;
                    option.textContent = `${lang.name} (${lang.code})`;
                    newTranslationSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Eroare la încărcarea limbilor pentru traduceri noi:', error);
            }
        }
        
        // Verifică capacitățile de traducere
        async function checkTranslationCapabilities() {
            try {
                const response = await fetch('/get_translation_capabilities');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                translationCapabilities = data.available_targets;
                
                if (data.available_targets.length > 0) {
                    translationPanel.style.display = 'block';
                }
            } catch (error) {
                console.error('Eroare la verificarea capacităților de traducere:', error);
            }
        }
        
        // Încarcă statusul modelelor
        async function loadModelStatus() {
            try {
                const response = await fetch('/model_status');
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                modelsStatus = data.status;
                
                for (const modelId in modelsStatus) {
                    const statusElement = document.getElementById(`status-${modelId}`);
                    if (statusElement) {
                        if (modelsStatus[modelId].loaded) {
                            statusElement.className = 'model-status loaded';
                            statusElement.title = `Încărcat pe ${modelsStatus[modelId].device}`;
                        } else {
                            statusElement.className = 'model-status';
                            statusElement.title = 'Nu este încărcat';
                        }
                    }
                }
            } catch (error) {
                console.error('Eroare la încărcarea statusului:', error);
            }
        }
        
        // Încarcă informații sistem
        async function loadSystemInfo() {
            try {
                const response = await fetch('/system_info');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                deviceInfo.textContent = `CPU: ${data.cpu_count} cores`;
                memoryInfo.textContent = `Memorie: ${data.available_memory}`;
                uploadInfo.textContent = `Max: ${data.max_file_size} • Chunk: ${data.chunk_size}`;
                timeoutInfo.textContent = `Timeout: ${data.process_timeout}`;
                
            } catch (error) {
                console.error('Eroare la încărcarea informațiilor sistem:', error);
            }
        }
        
        // Selectează modelul
        async function selectModel(modelId) {
            try {
                const response = await fetch('/set_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model: modelId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentModel = modelId;
                    updateCurrentModel();
                    loadModels();
                    showToast(`Model setat la: ${modelId}`, 'success');
                } else {
                    throw new Error(data.error || 'Eroare necunoscută');
                }
            } catch (error) {
                console.error('Eroare la selectarea modelului:', error);
                showToast('Eroare la schimbarea modelului', 'error');
            }
        }
        
        // Actualizează limba
        async function updateLanguage() {
            const language = languageSelect.value;
            try {
                const response = await fetch('/set_language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language: language })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentLanguage = language;
                    updateCurrentLanguage();
                    showToast(data.message, 'success');
                    
                    checkTranslationCapabilities();
                }
            } catch (error) {
                console.error('Eroare la actualizarea limbii:', error);
            }
        }
        
        // Actualizează limba țintă pentru traducere
        async function updateTranslationTarget() {
            const targetLanguage = translationSelect.value;
            
            if (!targetLanguage) {
                translationEnabled = false;
                updateTranslationUI();
                return;
            }
            
            try {
                const response = await fetch('/set_translation_target', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ target_language: targetLanguage })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    translationTarget = targetLanguage;
                    translationEnabled = true;
                    updateTranslationUI();
                    showToast(data.message, 'success');
                } else {
                    throw new Error(data.error || 'Eroare necunoscută');
                }
            } catch (error) {
                console.error('Eroare la actualizarea limbii țintă:', error);
                showToast('Eroare la setarea traducerii', 'error');
            }
        }
        
        // Activează/dezactivează traducerea
        function toggleTranslation() {
            translationEnabled = !translationEnabled;
            
            if (translationEnabled) {
                translationControls.style.display = 'grid';
                toggleTranslationBtn.innerHTML = '<i class="fas fa-toggle-on"></i> Activată';
                toggleTranslationBtn.classList.add('active');
                
                if (!translationSelect.value && translationSelect.options.length > 1) {
                    translationSelect.value = translationSelect.options[1].value;
                    updateTranslationTarget();
                }
            } else {
                translationControls.style.display = 'none';
                toggleTranslationBtn.innerHTML = '<i class="fas fa-toggle-off"></i> Dezactivată';
                toggleTranslationBtn.classList.remove('active');
                translationTarget = null;
                translationEnabled = false;
                
                translationSelect.value = '';
                
                fetch('/set_translation_target', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ target_language: '' })
                });
                
                showToast('Traducere dezactivată', 'info');
            }
            
            updateTranslationBadge();
        }
        
        // Actualizează interfața pentru traducere
        function updateTranslationUI() {
            if (translationEnabled && translationTarget) {
                translationControls.style.display = 'grid';
                toggleTranslationBtn.innerHTML = '<i class="fas fa-toggle-on"></i> Activată';
                toggleTranslationBtn.classList.add('active');
                translationSelect.value = translationTarget;
            } else {
                translationControls.style.display = 'none';
                toggleTranslationBtn.innerHTML = '<i class="fas fa-toggle-off"></i> Dezactivată';
                toggleTranslationBtn.classList.remove('active');
            }
            
            updateTranslationBadge();
        }
        
        // Actualizează badge-ul de traducere
        function updateTranslationBadge() {
            if (translationEnabled && translationTarget) {
                translationBadge.style.display = 'inline-block';
                translationBadge.innerHTML = `<i class="fas fa-language"></i> → ${translationTarget.toUpperCase()}`;
                translationBadge.title = `Traducere activă în ${translationTarget}`;
            } else {
                translationBadge.style.display = 'none';
            }
        }
        
        // Actualizează setările de segmentare
        async function updateSegmentationSettings() {
            updateSliderValues();
            
            segmentationSettings = {
                min_duration: parseFloat(minDurationSlider.value),
                max_duration: parseFloat(maxDurationSlider.value),
                max_chars: parseInt(maxCharsSlider.value),
                adjust_segmentation: adjustSegmentationCheckbox.checked
            };
            
            updateSegmentationStatus();
            
            try {
                const response = await fetch('/set_segmentation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(segmentationSettings)
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('Eroare la salvarea setărilor:', data.error);
                }
            } catch (error) {
                console.error('Eroare la actualizarea setărilor:', error);
            }
        }
        
        // Actualizează valorile slider-elor
        function updateSliderValues() {
            minDurationValue.textContent = `${minDurationSlider.value}s`;
            maxDurationValue.textContent = `${maxDurationSlider.value}s`;
            maxCharsValue.textContent = maxCharsSlider.value;
        }
        
        // Activează/dezactivează controalele de segmentare
        function toggleSegmentationControls() {
            const isEnabled = adjustSegmentationCheckbox.checked;
            segmentationControls.style.opacity = isEnabled ? '1' : '0.5';
            segmentationControls.style.pointerEvents = isEnabled ? 'all' : 'none';
            updateSegmentationSettings();
        }
        
        // Actualizează afișajul modelului curent
        function updateCurrentModel() {
            currentModelElement.textContent = currentModel;
            currentModelElement.title = `Model curent: ${currentModel}`;
        }
        
        // Actualizează afișajul limbii curente
        function updateCurrentLanguage() {
            const languageName = languageSelect.options[languageSelect.selectedIndex].text;
            currentLanguageElement.textContent = currentLanguage === 'auto' ? 'auto' : currentLanguage;
            currentLanguageElement.title = `Limbă curentă: ${languageName}`;
        }
        
        // Actualizează statusul segmentării
        function updateSegmentationStatus() {
            const isEnabled = adjustSegmentationCheckbox.checked;
            segmentationStatusElement.textContent = isEnabled ? 
                `Segmentare: ON (${minDurationSlider.value}-${maxDurationSlider.value}s)` : 
                'Segmentare: OFF';
            segmentationStatusElement.title = isEnabled ? 
                `Durată: ${minDurationSlider.value}-${maxDurationSlider.value}s, Max ${maxCharsSlider.value} caractere` : 
                'Segmentare dezactivată';
        }
        
        // Evenimente drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            uploadArea.classList.add('highlight');
        }
        
        function unhighlight() {
            uploadArea.classList.remove('highlight');
        }
        
        uploadArea.addEventListener('drop', handleDrop, false);
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', handleFileSelect);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        function handleFileSelect() {
            handleFiles(this.files);
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            
            // Verifică dimensiunea maximă
            if (file.size > maxChunkedSize) {
                showError(`Fișierul este prea mare. Maxim ${formatFileSize(maxChunkedSize)}.`);
                return;
            }
            
            // Verifică extensia
            const fileName = file.name.toLowerCase();
            const isSupportedVideo = ['.mp4', '.avi', '.mov', '.mkv', '.mxf', '.wmv', '.flv'].some(ext => 
                fileName.endsWith(ext));
            const isSupportedAudio = ['.mp3', '.wav', '.mpeg'].some(ext => 
                fileName.endsWith(ext));
            
            if (!isSupportedVideo && !isSupportedAudio) {
                showError('Format fișier neacceptat. Folosește MP4, AVI, MOV, MKV, MXF, WMV, FLV, MP3 sau WAV.');
                return;
            }
            
            selectedFile = file;
            isVideoFile = isSupportedVideo;
            isMp4File = fileName.endsWith('.mp4');
            
            // Verifică compatibilitatea cu metoda de upload selectată
            checkFileCompatibility();
            
            uploadText.innerHTML = `<i class="fas fa-file-alt"></i> ${file.name} (${formatFileSize(file.size)})`;
            
            // Ascunde rezultatele anterioare
            resultContainer.style.display = 'none';
            processingInfo.style.display = 'none';
            segmentsPreview.style.display = 'none';
            videoPreviewContainer.style.display = 'none';
            multipleTranslationsPanel.style.display = 'none';
            hideError();
            hideScrollButton();
            
            // Reset video preview
            videoPreview.style.display = 'none';
            imagePreview.style.display = 'none';
            videoPreview.src = '';
            imagePreview.src = '';
            
            // Extrage preview video dacă e fișier video și nu e prea mare
            if (isVideoFile && file.size < 100 * 1024 * 1024) { // <100MB pentru preview
                extractVideoPreview(file);
            } else {
                formatInfo.style.display = 'none';
            }
        }
        
        // Verifică compatibilitatea fișierului cu metoda de upload
        function checkFileCompatibility() {
            const fileSize = selectedFile.size;
            
            // Ascunde toate warning-urile inițial
            sizeWarning.style.display = 'none';
            fallbackOptions.style.display = 'none';
            chunkedUploadProgress.style.display = 'none';
            
            // Verifică dacă fișierul e prea mare pentru upload simplu
            if (fileSize > maxSimpleSize) {
                if (uploadMethod === 'simple') {
                    // Fișier prea mare pentru upload simplu
                    fallbackOptions.style.display = 'block';
                    processBtn.disabled = true;
                    quickPreviewBtn.disabled = true;
                    return;
                } else {
                    // Upload segmentat - afișează warning
                    sizeWarning.style.display = 'block';
                }
            } else if (fileSize > 100 * 1024 * 1024) { // >100MB
                // Afișează recomandare pentru upload segmentat
                sizeWarning.style.display = 'block';
            }
            
            // Activează butoanele
            processBtn.disabled = false;
            quickPreviewBtn.disabled = false;
            
            // Pentru upload segmentat, pregătește interfața
            if (uploadMethod === 'chunked' && fileSize > maxSimpleSize) {
                prepareChunkedUpload();
            }
        }
        
        // Pregătește interfața pentru upload segmentat
        function prepareChunkedUpload() {
            chunkedUploadProgress.style.display = 'block';
            
            // Calculează numărul de chunks
            totalChunks = Math.ceil(selectedFile.size / chunkSize);
            uploadedChunks = 0;
            
            // Actualizează informațiile
            uploadFileName.textContent = selectedFile.name;
            totalSize.textContent = formatFileSize(selectedFile.size);
            uploadedSize.textContent = '0 MB';
            uploadPercentage.textContent = '0%';
            uploadProgressFill.style.width = '0%';
            chunksProcessed.textContent = `0/${totalChunks}`;
            uploadStatus.textContent = 'Gata pentru upload';
            
            // Creează indicatori pentru chunks
            chunkStatus.innerHTML = '';
            for (let i = 0; i < totalChunks; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'chunk-indicator';
                indicator.id = `chunk-${i}`;
                chunkStatus.appendChild(indicator);
            }
            
            // Resetează variabilele de control
            uploadPaused = false;
            uploadCancelled = false;
            uploadStartTime = null;
            
            // Configurează butoanele
            pauseUploadBtn.style.display = 'flex';
            resumeUploadBtn.style.display = 'none';
            cancelUploadBtn.style.display = 'flex';
        }
        
        // Formatează dimensiunea fișierului
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Extrage preview video
        async function extractVideoPreview(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/video_preview', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.is_video) {
                    imagePreview.src = data.preview_url;
                    imagePreview.style.display = 'block';
                    videoDuration = data.duration;
                    
                    totalTimeElement.textContent = formatTime(videoDuration);
                    videoPreviewContainer.style.display = 'block';
                    
                    playVideoBtn.onclick = () => playVideoWithSubtitles();
                    playVideoBtn.innerHTML = '<i class="fas fa-play"></i> Play cu Subtitrări';
                    videoPlaying = false;
                    
                    showToast('Preview video extras!', 'success');
                }
            } catch (error) {
                console.error('Eroare la extragerea preview video:', error);
            }
        }
        
        // Previzualizare rapidă
        async function quickPreview() {
            if (!selectedFile) return;
            
            // Pentru fișiere mari, folosește upload segmentat
            if (selectedFile.size > maxSimpleSize && uploadMethod === 'simple') {
                showToast('Fișier prea mare pentru previzualizare rapidă. Folosește upload segmentat.', 'warning');
                return;
            }
            
            hideError();
            segmentsPreview.style.display = 'block';
            previewContent.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Se procesează previzualizarea...</p>';
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                const response = await fetch('/preview_transcription', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    previewSegments = data.preview;
                    
                    let html = `<p><small>Model: ${data.model_used}, Limbă detectată: ${data.detected_language}</small></p>`;
                    
                    previewSegments.forEach(segment => {
                        html += `
                            <div class="preview-segment">
                                <div class="preview-segment-header">
                                    <span>#${segment.id}</span>
                                    <span>${segment.start_formatted} → ${segment.end_formatted}</span>
                                </div>
                                <div class="preview-segment-text">${segment.text}</div>
                            </div>
                        `;
                    });
                    
                    if (data.has_more) {
                        html += `<p style="text-align: center; color: #718096; margin-top: 10px;">
                            <i class="fas fa-ellipsis-h"></i> și încă ${data.total_segments - previewSegments.length} segmente
                        </p>`;
                    }
                    
                    previewContent.innerHTML = html;
                    
                    if (isVideoFile) {
                        showToast('Previzualizare completă!', 'success');
                    }
                } else {
                    throw new Error(data.error || 'Eroare la previzualizare');
                }
            } catch (error) {
                showError(`Eroare previzualizare: ${error.message}`);
                segmentsPreview.style.display = 'none';
            }
        }
        
        // Procesează fișierul complet
        async function processFile() {
            if (!selectedFile) return;
            
            // Pentru fișiere mari cu upload simplu, arată opțiuni
            if (selectedFile.size > maxSimpleSize && uploadMethod === 'simple') {
                fallbackOptions.style.display = 'block';
                return;
            }
            
            // Pentru upload segmentat
            if (uploadMethod === 'chunked' && selectedFile.size > maxSimpleSize) {
                startChunkedUpload();
                return;
            }
            
            // Pentru upload simplu (fișiere mici)
            processSimpleUpload();
        }
        
        // Procesează upload simplu
        async function processSimpleUpload() {
            hideError();
            resultContainer.style.display = 'none';
            segmentsPreview.style.display = 'none';
            loading.style.display = 'block';
            processBtn.disabled = true;
            quickPreviewBtn.disabled = true;
            progressContainer.style.display = 'block';
            processingInfo.style.display = 'none';
            formatInfo.style.display = 'none';
            
            if (translationEnabled) {
                loadingTranslationInfo.style.display = 'block';
                translationProgress.style.display = 'block';
            } else {
                loadingTranslationInfo.style.display = 'none';
                translationProgress.style.display = 'none';
            }
            
            updateProgress(0, 'Se pregătește...');
            updateTranslationProgress(0, 'Se pregătește traducerea...');
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('model', currentModel);
            formData.append('language', currentLanguage);
            formData.append('translation_target', translationTarget || '');
            formData.append('adjust_segmentation', adjustSegmentationCheckbox.checked);
            formData.append('extract_audio_only', extractAudioOnlyCheckbox.checked);
            
            try {
                updateProgress(10, 'Se încarcă fișierul...');
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    processId = data.process_id;
                    pollTaskStatus(processId);
                } else {
                    if (data.use_chunked_upload) {
                        showToast('Fișier prea mare. Se recomandă upload segmentat.', 'warning');
                        fallbackOptions.style.display = 'block';
                        loading.style.display = 'none';
                        progressContainer.style.display = 'none';
                        processBtn.disabled = false;
                        quickPreviewBtn.disabled = false;
                    } else {
                        throw new Error(data.error || 'Eroare necunoscută');
                    }
                }
                
            } catch (error) {
                loading.style.display = 'none';
                progressContainer.style.display = 'none';
                translationProgress.style.display = 'none';
                loadingTranslationInfo.style.display = 'none';
                showError(`Eroare: ${error.message}`);
                processBtn.disabled = false;
                quickPreviewBtn.disabled = false;
            }
        }
        
        // Începe upload segmentat
        async function startChunkedUpload() {
            hideError();
            resultContainer.style.display = 'none';
            processingInfo.style.display = 'none';
            formatInfo.style.display = 'none';
            
            // Actualizează interfața
            uploadStatus.textContent = 'Se inițializează...';
            pauseUploadBtn.disabled = false;
            cancelUploadBtn.disabled = false;
            resumeUploadBtn.style.display = 'none';
            
            try {
                // Inițializează sesiunea de upload
                const initResponse = await fetch('/api/chunk_upload/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileName: selectedFile.name,
                        fileSize: selectedFile.size,
                        totalChunks: totalChunks
                    })
                });
                
                const initData = await initResponse.json();
                
                if (!initData.success) {
                    throw new Error(initData.error || 'Eroare la inițializarea upload-ului');
                }
                
                chunkedUploadSession = initData.sessionId;
                uploadStartTime = Date.now();
                uploadStatus.textContent = 'Se încarcă...';
                
                // Încarcă chunks în serie pentru a evita problemele de memorie
                await uploadChunksSequentially();
                
                // După ce toate chunks sunt încărcate, începe procesarea
                if (!uploadCancelled) {
                    await processAfterUpload();
                }
                
            } catch (error) {
                console.error('Eroare la upload segmentat:', error);
                showError(`Eroare upload segmentat: ${error.message}`);
                uploadStatus.textContent = 'Eroare';
            }
        }
        
        // Încarcă chunks în mod secvențial
        async function uploadChunksSequentially() {
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                if (uploadPaused) {
                    uploadStatus.textContent = 'Pauză';
                    while (uploadPaused && !uploadCancelled) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    if (uploadCancelled) {
                        uploadStatus.textContent = 'Anulat';
                        break;
                    }
                    
                    uploadStatus.textContent = 'Se încarcă...';
                }
                
                if (uploadCancelled) {
                    uploadStatus.textContent = 'Anulat';
                    break;
                }
                
                try {
                    // Creează chunk-ul
                    const start = chunkIndex * chunkSize;
                    const end = Math.min(start + chunkSize, selectedFile.size);
                    const chunk = selectedFile.slice(start, end);
                    
                    // Creează FormData pentru chunk
                    const formData = new FormData();
                    formData.append('chunk', chunk);
                    formData.append('chunkNumber', chunkIndex.toString());
                    formData.append('totalChunks', totalChunks.toString());
                    formData.append('sessionId', chunkedUploadSession);
                    
                    // Încarcă chunk-ul
                    const uploadResponse = await fetch('/api/chunk_upload/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (!uploadData.success) {
                        throw new Error(uploadData.error || `Eroare la încărcarea chunk-ului ${chunkIndex}`);
                    }
                    
                    // Actualizează progresul
                    uploadedChunks = chunkIndex + 1;
                    updateUploadProgress();
                    
                    // Actualizează indicatorul chunk
                    const chunkIndicator = document.getElementById(`chunk-${chunkIndex}`);
                    if (chunkIndicator) {
                        chunkIndicator.classList.add('uploaded');
                    }
                    
                } catch (error) {
                    console.error(`Eroare la chunk ${chunkIndex}:`, error);
                    uploadStatus.textContent = 'Eroare la încărcare';
                    throw error;
                }
            }
        }
        
        // Actualizează progresul upload-ului
        function updateUploadProgress() {
            const progress = (uploadedChunks / totalChunks) * 100;
            const uploadedBytes = uploadedChunks * chunkSize;
            const currentTime = Date.now();
            const elapsedSeconds = (currentTime - uploadStartTime) / 1000;
            
            // Calculează viteza
            const speed = elapsedSeconds > 0 ? uploadedBytes / elapsedSeconds : 0;
            const remainingChunks = totalChunks - uploadedChunks;
            const estimatedSeconds = speed > 0 ? (selectedFile.size - uploadedBytes) / speed : 0;
            
            // Actualizează UI
            uploadProgressFill.style.width = `${progress}%`;
            uploadPercentage.textContent = `${progress.toFixed(1)}%`;
            uploadedSize.textContent = formatFileSize(uploadedBytes);
            chunksProcessed.textContent = `${uploadedChunks}/${totalChunks}`;
            uploadSpeed.textContent = `${formatFileSize(speed)}/s`;
            averageSpeed.textContent = `${formatFileSize(speed)}/s`;
            
            if (estimatedSeconds > 0) {
                const minutes = Math.floor(estimatedSeconds / 60);
                const seconds = Math.floor(estimatedSeconds % 60);
                estimatedTime.textContent = `${minutes}m ${seconds}s`;
            } else {
                estimatedTime.textContent = '-';
            }
        }
        
        // Pauzează upload-ul
        function pauseUpload() {
            uploadPaused = true;
            pauseUploadBtn.style.display = 'none';
            resumeUploadBtn.style.display = 'flex';
            uploadStatus.textContent = 'Pauză';
            showToast('Upload paused', 'info');
        }
        
        // Reluare upload
        function resumeUpload() {
            uploadPaused = false;
            pauseUploadBtn.style.display = 'flex';
            resumeUploadBtn.style.display = 'none';
            uploadStatus.textContent = 'Se încarcă...';
            showToast('Upload resumed', 'info');
        }
        
        // Anulează upload-ul
        function cancelUpload() {
            uploadCancelled = true;
            uploadPaused = false;
            uploadStatus.textContent = 'Se anulează...';
            
            // Cleanup sesiune
            if (chunkedUploadSession) {
                fetch(`/api/chunk_upload/cleanup/${chunkedUploadSession}`, {
                    method: 'DELETE'
                }).catch(console.error);
            }
            
            setTimeout(() => {
                chunkedUploadProgress.style.display = 'none';
                processBtn.disabled = false;
                quickPreviewBtn.disabled = false;
                showToast('Upload anulat', 'info');
            }, 1000);
        }
        
        // Procesează după upload complet
        async function processAfterUpload() {
            try {
                uploadStatus.textContent = 'Se procesează...';
                
                // Afișează loading
                loading.style.display = 'block';
                processBtn.disabled = true;
                quickPreviewBtn.disabled = true;
                
                if (translationEnabled) {
                    loadingTranslationInfo.style.display = 'block';
                    translationProgress.style.display = 'block';
                }
                
                // Trimite cerere pentru procesare
                const processResponse = await fetch(`/api/chunk_upload/process/${chunkedUploadSession}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        language: currentLanguage,
                        translation_target: translationTarget || '',
                        adjust_segmentation: adjustSegmentationCheckbox.checked,
                        extract_audio_only: extractAudioOnlyCheckbox.checked
                    })
                });
                
                const processData = await processResponse.json();
                
                if (processData.success) {
                    processId = processData.process_id;
                    pollTaskStatus(processId);
                } else {
                    throw new Error(processData.error || 'Eroare la procesare');
                }
                
            } catch (error) {
                console.error('Eroare la procesare:', error);
                showError(`Eroare procesare: ${error.message}`);
                loading.style.display = 'none';
                processBtn.disabled = false;
                quickPreviewBtn.disabled = false;
                uploadStatus.textContent = 'Eroare procesare';
            }
        }
        
        // Funcții helper pentru procesare
        function switchToChunkedUpload() {
            selectUploadMethod('chunked');
            fallbackOptions.style.display = 'none';
            checkFileCompatibility();
        }
        
        function extractAudioOnly() {
            extractAudioOnlyCheckbox.checked = true;
            if (selectedFile && selectedFile.size > maxSimpleSize) {
                switchToChunkedUpload();
            }
            showToast('S-a activat modul "Doar extragere audio". Click pe Start.', 'info');
        }
        
        // Poll statusul task-ului
        async function pollTaskStatus(pid) {
            console.log('Polling status for task:', pid);
            try {
                const response = await fetch(`/api/task_status/${pid}`);
                if (!response.ok) {
                    console.error('Polling request failed:', response.status, response.statusText);
                    // Încercăm din nou după 5 secunde în caz de eroare de rețea/tunnel
                    setTimeout(() => pollTaskStatus(pid), 5000);
                    return;
                }

                const data = await response.json();
                console.log('Task status update:', data.status, data.progress + '%');

                if (data.status === 'completed') {
                    console.log('Task completed successfully!');
                    handleProcessingResult(data.result);
                } else if (data.status === 'error') {
                    console.error('Task reported an error:', data.message);
                    throw new Error(data.message || 'Eroare la procesare în background');
                } else {
                    // Update progress UI
                    if (data.status === 'processing') {
                        updateProgress(data.progress || 50, data.message || 'Se procesează...');
                        if (uploadStatus) uploadStatus.textContent = data.message;
                    } else if (data.status === 'queued') {
                        updateProgress(5, 'În coadă...');
                    }

                    // Poll again after 2 seconds
                    setTimeout(() => pollTaskStatus(pid), 2000);
                }
            } catch (error) {
                loading.style.display = 'none';
                progressContainer.style.display = 'none';
                showError(`Eroare monitorizare: ${error.message}`);
                processBtn.disabled = false;
                quickPreviewBtn.disabled = false;
            }
        }

        // Procesează rezultatul
        async function handleProcessingResult(data) {
            console.log('Processing result received:', data);
            updateProgress(100, 'Finalizare...');
            
            // Re-încărcăm segmentele de pe disc pentru că nu mai vin în rezultatul task-ului
            try {
                if (!data.audio_only) {
                    const pid = data.process_id || processId;
                    console.log('Fetching segments for process:', pid);

                    const segResp = await fetch(`/segments_json/${pid}/original_segments.json?t=${Date.now()}`);
                    if (segResp.ok) {
                        const segData = await segResp.json();
                        originalSegments = segData.segments;
                        currentSegments = originalSegments;
                        console.log('Original segments loaded:', originalSegments.length);
                    }

                    if (data.translation_used) {
                        const transResp = await fetch(`/segments_json/${pid}/translated_segments_${data.translation_used}.json?t=${Date.now()}`);
                        if (transResp.ok) {
                            const transData = await transResp.json();
                            translatedSegments = transData.segments;
                            currentSegments = translatedSegments; // Implicit arată traducerea dacă a fost cerută
                            console.log('Translated segments loaded and set as current:', translatedSegments.length);
                        }
                    }
                }
            } catch (e) {
                console.error('Eroare la încărcarea segmentelor de pe disc:', e);
            }

            if (data.audio_only) {
                loading.style.display = 'none';
                progressContainer.style.display = 'none';
                chunkedUploadProgress.style.display = 'none';

                document.getElementById('resultTitle').innerHTML = '<i class="fas fa-check-circle"></i> Audio extras!';
                document.getElementById('audioOnlyResult').style.display = 'block';
                document.getElementById('transcriptionResult').style.display = 'none';
                document.getElementById('transcriptionButtons').style.display = 'none';
                document.getElementById('audioDownloadLink').href = `/download/${data.process_id}/${data.audio_filename}`;

                resultContainer.style.display = 'block';
                showToast('Audio extras cu succes!', 'success');
                return;
            }

            // Re-asigură-te că vedem transcrierea
            document.getElementById('resultTitle').innerHTML = '<i class="fas fa-check-circle"></i> Transcriere finalizată!';
            document.getElementById('audioOnlyResult').style.display = 'none';
            document.getElementById('transcriptionResult').style.display = 'block';
            document.getElementById('transcriptionButtons').style.display = 'flex';

            if (translationEnabled && data.translation_used) {
                updateTranslationProgress(100, 'Traducere completă!');
            }
            
            // Salvează datele
            srtFilename = data.filename;
            processId = data.process_id || processId;

            // Fallback: folosim datele din rezultat doar dacă fetch-ul de pe disc a eșuat
            if (!currentSegments || currentSegments.length === 0) {
                if (data.segments) currentSegments = data.segments;
                if (data.original_segments) originalSegments = data.original_segments;
                if (data.translated_segments) translatedSegments = data.translated_segments;
            }

            imagePreviewUrl = data.image_preview_url;
            videoPreviewUrl = data.video_preview_url;
            videoDuration = data.video_duration || data.total_duration;
            isMp4File = data.is_mp4 || false;
            
            // Resetează traducerile multiple
            multipleTranslations = {};
            if (data.is_translated && data.translation_target) {
                multipleTranslations[data.translation_target] = translatedSegments;
                currentTranslationLang = data.translation_target;
            }
            
            // Afișează textul complet
            document.getElementById('fullText').textContent = data.full_text;
            
            // Afișează segmentele (inițial originale)
            displaySegments(originalSegments);
            
            // Afișează informații procesare
            infoModel.textContent = `${data.model_used} ${isMp4File ? '(MP4 direct)' : `(${data.original_format} → MP4)`}`;
            infoTime.textContent = data.processing_time;
            infoLanguage.textContent = data.language_used;
            
            if (data.is_translated) {
                infoTranslation.textContent = `${data.translation_used} (${data.translation_time})`;
                infoTranslation.style.color = '#2b6cb0';
                infoTranslation.style.fontWeight = 'bold';
                
                // Afișează butoanele pentru traducere
                toggleSegmentsTranslationBtn.style.display = 'inline-flex';
                downloadTranslatedBtn.style.display = 'inline-flex';
                mainDownloadTranslatedBtn.style.display = 'inline-flex';
                
                // Actualizează numele fișierului tradus
                translatedSrtFilename = srtFilename.replace(/_([a-z]{2})\.srt$/, `_${data.translation_used}.srt`);
            } else {
                infoTranslation.textContent = 'Nu';
                infoTranslation.style.color = '#718096';
                
                // Ascunde butoanele pentru traducere
                toggleSegmentsTranslationBtn.style.display = 'none';
                downloadTranslatedBtn.style.display = 'none';
                mainDownloadTranslatedBtn.style.display = 'none';
            }
            
            processingInfo.style.display = 'block';
            
            // Actualizează video preview dacă există
            if (data.is_video) {
                if (videoPreviewUrl) {
                    console.log('Setting video preview src:', videoPreviewUrl);
                    // Adăugăm un timestamp pentru a forța reîncărcarea prin tunnel/cache
                    videoPreview.src = videoPreviewUrl + '?t=' + Date.now();
                    videoPreview.load(); // Forțează încărcarea
                    videoPreview.style.display = 'block';
                    imagePreview.style.display = 'none';
                    
                    if (isMp4File) {
                        showToast('✓ MP4: Video original pentru playback', 'success');
                    } else {
                        showToast(`✓ ${data.original_format.toUpperCase()}: Convertit la MP4`, 'info');
                    }
                } else if (imagePreviewUrl) {
                    imagePreview.src = imagePreviewUrl;
                    imagePreview.style.display = 'block';
                    videoPreview.style.display = 'none';
                }
                videoPreviewContainer.style.display = 'block';
                totalTimeElement.textContent = formatTime(videoDuration);
                playWithSubtitlesBtn.style.display = 'inline-flex';
            } else {
                playWithSubtitlesBtn.style.display = 'none';
            }
            
            // Arată rezultatele
            setTimeout(() => {
                loading.style.display = 'none';
                progressContainer.style.display = 'none';
                translationProgress.style.display = 'none';
                loadingTranslationInfo.style.display = 'none';
                chunkedUploadProgress.style.display = 'none';
                resultContainer.style.display = 'block';
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                
                if (data.is_translated) {
                    showToast('Transcriere și traducere complete!', 'success');
                } else {
                    showToast('Transcriere completă!', 'success');
                }
                
                // Încarcă lista de traduceri existente
                refreshTranslationsList();
                
                // Arată butonul pentru traduceri multiple
                showMultipleTranslationsBtn.style.display = 'inline-flex';
            }, 500);
        }
        
        // Restul funcțiilor rămân la fel (displaySegments, toggleSegmentsTranslation, etc.)
        // ... (codul rămas este identic cu cel din versiunea anterioară)
        
        // Actualizează textul segmentului în memoria locală
        function updateSegmentLocal(id, newText) {
            const segment = currentSegments.find(s => s.id === id);
            if (segment) {
                segment.text = newText;
            }
        }

        // Salvează modificările pe server
        async function saveEdits() {
            if (!processId || !currentSegments.length) {
                showToast('Nu există date de salvat', 'warning');
                return;
            }

            saveEditsBtn.disabled = true;
            const originalContent = saveEditsBtn.innerHTML;
            saveEditsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Se salvează...';

            try {
                const response = await fetch('/api/save_edits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        process_id: processId,
                        segments: currentSegments,
                        is_translated: !!currentTranslationLang,
                        target_lang: currentTranslationLang
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Modificările au fost salvate cu succes!', 'success');
                    if (data.srt_filename) {
                        if (currentTranslationLang) {
                            translatedSrtFilename = data.srt_filename;
                        } else {
                            srtFilename = data.srt_filename;
                        }
                    }
                } else {
                    throw new Error(data.error || 'Eroare la salvare');
                }
            } catch (error) {
                console.error('Eroare la salvarea modificărilor:', error);
                showError(`Eroare la salvare: ${error.message}`);
                showToast('Eroare la salvare', 'error');
            } finally {
                saveEditsBtn.disabled = false;
                saveEditsBtn.innerHTML = originalContent;
            }
        }

        // Afișează segmentele
        function displaySegments(segments) {
            if (!segments || !Array.isArray(segments)) {
                console.error('Segments invalid or not an array:', segments);
                return;
            }

            let segmentsHtml = '';
            
            segments.forEach(segment => {
                const isTranslated = segment.original === false;
                const targetLang = segment.target_language || 'unknown';
                
                // Căutăm textul original dacă suntem pe o traducere
                let originalText = "";
                if (isTranslated && originalSegments.length > 0) {
                    const orig = originalSegments.find(s => s.id === segment.id);
                    if (orig) originalText = orig.text;
                }

                segmentsHtml += `
                    <div class="segment" data-start="${segment.start}" data-end="${segment.end}">
                        <div class="segment-header">
                            <span><i class="fas fa-hashtag"></i> #${segment.id}</span>
                            <span><i class="far fa-clock"></i> ${segment.start_formatted} → ${segment.end_formatted}</span>
                            ${isTranslated ? `<span class="language-badge target">${targetLang}</span>` : ''}
                        </div>
                        <div class="segment-text" contenteditable="true" onblur="updateSegmentLocal(${segment.id}, this.innerText)">${segment.text}</div>
                        ${isTranslated && originalText ? `
                            <div class="segment-translation" style="margin-top: 5px; opacity: 0.7; font-size: 0.9em; border-top: 1px solid #eee; padding-top: 5px;">
                                <div style="color: #718096;"><i class="fas fa-quote-left"></i> ${originalText}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('segmentsList').innerHTML = segmentsHtml;
        }
        
        // Comută între afișarea segmentelor originale și traduse
        function toggleSegmentsTranslation() {
            showTranslatedSegments = !showTranslatedSegments;
            
            if (showTranslatedSegments && translatedSegments.length > 0) {
                currentSegments = translatedSegments;
                currentTranslationLang = translationTarget; // sau limba țintă curentă
                displaySegments(translatedSegments);
                toggleSegmentsTranslationBtn.innerHTML = '<i class="fas fa-language"></i> Afișează Original';
                toggleSegmentsTranslationBtn.classList.add('active');
                showToast('Afișează segmente traduse', 'info');
            } else {
                currentSegments = originalSegments;
                currentTranslationLang = null;
                displaySegments(originalSegments);
                toggleSegmentsTranslationBtn.innerHTML = '<i class="fas fa-language"></i> Afișează Traducerea';
                toggleSegmentsTranslationBtn.classList.remove('active');
                showToast('Afișează segmente originale', 'info');
            }
        }
        
        // Arată panoul pentru traduceri multiple
        function showMultipleTranslations() {
            multipleTranslationsPanel.style.display = 'block';
            refreshTranslationsList();
            window.scrollTo({ 
                top: multipleTranslationsPanel.offsetTop - 20, 
                behavior: 'smooth' 
            });
        }
        
        // Încarcă lista de traduceri existente
        async function refreshTranslationsList() {
            try {
                const response = await fetch('/get_existing_translations');
                const data = await response.json();
                
                if (data.success) {
                    let html = '';
                    
                    if (data.total_translations > 0) {
                        html += `<p><strong>Traduceri existente (${data.total_translations}):</strong></p>`;
                        html += '<div class="translations-list">';
                        
                        // Adaugă originalul
                        html += `
                            <div class="translation-item ${!currentTranslationLang ? 'active' : ''}" 
                                 onclick="loadTranslation(null)">
                                <span class="translation-lang">${data.detected_language}</span>
                                <span>(original)</span>
                                <span style="margin-left: auto; color: #718096;">${data.original_segments_count} segmente</span>
                            </div>
                        `;
                        
                        // Adaugă traducerile
                        data.translations.forEach(trans => {
                            // Stocăm și numele fișierului SRT
                            if (trans.srt_filename) {
                                if (!multipleTranslations[trans.target_language]) {
                                    multipleTranslations[trans.target_language] = { srt_filename: trans.srt_filename };
                                } else {
                                    multipleTranslations[trans.target_language].srt_filename = trans.srt_filename;
                                }
                            }

                            html += `
                                <div class="translation-item ${currentTranslationLang === trans.target_language ? 'active' : ''}" 
                                     onclick="loadTranslation('${trans.target_language}')">
                                    <span class="translation-lang">${trans.target_language}</span>
                                    <span>(${trans.target_name})</span>
                                    <button class="translation-action" onclick="downloadTranslationSRT('${trans.target_language}', event)">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <span style="margin-left: auto; color: #718096;">${trans.segment_count} segmente</span>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    } else {
                        html = '<p>Nu există traduceri salvate încă. Adaugă o traducere nouă mai jos.</p>';
                    }
                    
                    translationsListContainer.innerHTML = html;
                }
            } catch (error) {
                console.error('Eroare la încărcarea listei de traduceri:', error);
                translationsListContainer.innerHTML = '<p>Eroare la încărcarea traducerilor.</p>';
            }
        }
        
        // Încarcă o traducere specifică
        async function loadTranslation(langCode) {
            if (langCode === null) {
                currentSegments = originalSegments;
                currentTranslationLang = null;
                displaySegments(originalSegments);
                showToast('Se afișează segmentele originale', 'info');

                downloadTranslatedBtn.style.display = 'none';
                mainDownloadTranslatedBtn.style.display = 'none';
            } else {
                try {
                    // Dacă nu avem segmentele în memorie (doar meta-datele de la refresh)
                    if (!multipleTranslations[langCode] || !Array.isArray(multipleTranslations[langCode])) {
                        showToast(`Se încarcă traducerea în ${langCode}...`, 'info');

                        const filename = `translated_segments_${langCode}.json`;
                        const response = await fetch(`/segments_json/${processId}/${filename}`);
                        const data = await response.json();

                        if (data.segments) {
                            const srt_filename = multipleTranslations[langCode]?.srt_filename;
                            multipleTranslations[langCode] = data.segments;
                            if (srt_filename) multipleTranslations[langCode].srt_filename = srt_filename;
                        } else {
                            throw new Error('Nu s-au putut încărca segmentele');
                        }
                    }

                    currentSegments = multipleTranslations[langCode];
                    currentTranslationLang = langCode;

                    if (multipleTranslations[langCode].srt_filename) {
                        translatedSrtFilename = multipleTranslations[langCode].srt_filename;
                        downloadTranslatedBtn.style.display = 'inline-flex';
                        mainDownloadTranslatedBtn.style.display = 'inline-flex';
                    }

                    displaySegments(currentSegments);
                    showToast(`Se afișează traducerea în ${langCode}`, 'info');
                } catch (error) {
                    console.error('Eroare la încărcarea traducerii:', error);
                    showToast('Eroare la încărcarea traducerii de pe server', 'error');
                }
            }
            
            refreshTranslationsList();
        }
        
        // Adaugă o nouă traducere
        async function addNewTranslation() {
            const targetLang = newTranslationSelect.value;
            
            if (!targetLang) {
                showToast('Selectează o limbă pentru traducere', 'error');
                return;
            }
            
            if (!originalSegments || originalSegments.length === 0) {
                showToast('Nu există segmente pentru traducere. Încarcă un fișier mai întâi.', 'error');
                return;
            }
            
            const detectedLang = infoLanguage.textContent.trim();
            const langCode = detectedLang.split(' ')[0];
            
            console.log('Încerc să traduc din', langCode, 'în', targetLang);
            
            if (multipleTranslations[targetLang]) {
                showToast(`Traducerea în ${targetLang} există deja`, 'info');
                loadTranslation(targetLang);
                return;
            }
            
            try {
                showToast(`Se traduce în ${targetLang}...`, 'info');
                
                const originalBtnText = addTranslationBtn.innerHTML;
                addTranslationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Se traduce...';
                addTranslationBtn.disabled = true;
                
                const response = await fetch('/translate_existing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_lang: targetLang,
                        source_lang: langCode
                    })
                });
                
                const data = await response.json();
                
                addTranslationBtn.innerHTML = originalBtnText;
                addTranslationBtn.disabled = false;
                
                if (data.success) {
                    multipleTranslations[targetLang] = data.segments;
                    translatedSrtFilename = data.srt_filename;
                    loadTranslation(targetLang);
                    showToast(`Traducere în ${targetLang} completă! ${data.segment_count} segmente traduse`, 'success');
                    refreshTranslationsList();
                    
                    // Afișează butoanele de descărcare pentru traducere
                    downloadTranslatedBtn.style.display = 'inline-flex';
                    mainDownloadTranslatedBtn.style.display = 'inline-flex';

                    setTimeout(() => {
                        showToast(`Fișierul ${data.srt_filename} a fost generat`, 'info');
                    }, 500);
                } else {
                    throw new Error(data.error || 'Eroare la traducere');
                }
            } catch (error) {
                addTranslationBtn.innerHTML = '<i class="fas fa-plus"></i> Adaugă Traducere';
                addTranslationBtn.disabled = false;
                
                console.error('Eroare detaliată la traducere:', error);
                showToast(`Eroare la traducere: ${error.message}`, 'error');
            }
        }
        
        // Descarcă un fișier SRT pentru o traducere specifică
        function downloadTranslationSRT(langCode, event = null) {
            if (event) event.stopPropagation();
            
            if (!multipleTranslations[langCode]) {
                showToast(`Traducerea în ${langCode} nu există`, 'error');
                return;
            }
            
            showToast(`Descărcarea pentru ${langCode} va fi implementată în curând.`, 'info');
        }
        

        // Rulează video cu subtitrări sincronizate
        function playVideoWithSubtitles() {
            if (!currentSegments || !currentSegments.length) {
                showToast('Nu există subtitrări pentru a fi afișate', 'error');
                return;
            }
            
            if (!videoPlaying) {
                startPlayback();
            } else {
                stopPlayback();
            }
        }
        
        function startPlayback() {
            // Verificăm dacă avem o sursă video validă
            const hasVideo = videoPreview.src && !videoPreview.src.endsWith('/') && !videoPreview.src.includes('localhost:5000');
            // Notă: browserul pune uneori URL-ul bazei dacă src e gol. Verificăm și videoPreviewUrl.

            if (videoPreviewUrl || (videoPreview.src && videoPreview.src !== window.location.href)) {
                console.log('Starting video playback for src:', videoPreview.src);

                // Asigură-te că containerul e vizibil
                videoPreviewContainer.style.display = 'block';
                videoPreview.style.display = 'block';

                if (videoPreview.ended) {
                    videoPreview.currentTime = 0;
                }

                videoPreview.play().then(() => {
                    console.log('Video play command successful');
                }).catch(e => {
                    console.error('Playback error:', e);
                    showToast('Browser-ul a blocat redarea sau video-ul nu s-a încărcat.', 'error');

                    // Fallback la simulare dacă video-ul nu vrea să pornească deloc
                    if (!videoPlaying) {
                        console.log('Falling back to simulated playback');
                        startSimulatedPlayback();
                    }
                });
            } else {
                console.log('No video source, starting simulated playback');
                videoPlaying = true;
                playVideoBtn.innerHTML = '<i class="fas fa-pause"></i> Pauză';
                startSimulatedPlayback();
            }
        }
        
        function startSimulatedPlayback() {
            let currentTime = 0;
            const duration = videoDuration || currentSegments[currentSegments.length - 1].end + 5;
            
            videoPlayInterval = setInterval(() => {
                if (!videoPlaying) {
                    clearInterval(videoPlayInterval);
                    return;
                }
                
                currentTime += 0.1;
                
                if (currentTime >= duration) {
                    stopPlayback();
                    showToast('Playback terminat', 'info');
                    return;
                }
                
                currentTimeElement.textContent = formatTime(currentTime);
                updateCurrentSubtitle(currentTime);
            }, 100);
        }
        
        function updateCurrentSubtitle(currentTime) {
            if (!currentSegments || currentSegments.length === 0) {
                if (videoPlaying && Math.random() < 0.01) console.warn('No segments available for sync');
                return;
            }

            // Debugging ocazional (la fiecare 10 secunde de video)
            if (Math.floor(currentTime) % 10 === 0 && Math.random() < 0.05) {
                console.log(`Sync check: time=${currentTime.toFixed(2)}, segments=${currentSegments.length}`);
            }

            const segment = currentSegments.find(s => 
                currentTime >= s.start && currentTime <= s.end
            );
            
            if (segment) {
                const segmentIndex = currentSegments.indexOf(segment);
                if (segmentIndex !== currentSegmentIndex) {
                    console.log('New segment:', segmentIndex, segment.text.substring(0, 20) + '...');
                    currentSegmentIndex = segmentIndex;
                    currentSubtitle.textContent = segment.text;
                    subtitleTimestamp.textContent = `${segment.start_formatted} → ${segment.end_formatted}`;
                    subtitleOverlay.style.display = 'block';
                    
                    highlightCurrentSegment(segmentIndex);
                }
            } else {
                if (currentSubtitle.textContent !== '' || subtitleOverlay.style.display !== 'none') {
                    currentSubtitle.textContent = '';
                    subtitleTimestamp.textContent = '';
                    subtitleOverlay.style.display = 'none';
                    currentSegmentIndex = -1;
                }
            }
        }
        
        function highlightCurrentSegment(index) {
            document.querySelectorAll('.segment').forEach(seg => {
                seg.classList.remove('highlighted');
            });
            
            const segments = document.querySelectorAll('.segment');
            if (segments[index]) {
                segments[index].classList.add('highlighted');
                scrollToCurrentBtn.style.display = 'flex';
            }
        }
        
        function stopPlayback() {
            console.log('Stopping playback');
            videoPlaying = false;
            playVideoBtn.innerHTML = '<i class="fas fa-play"></i> Play cu Subtitrări';
            
            if (videoPreview) {
                videoPreview.pause();
            }
            
            if (videoPlayInterval) {
                clearInterval(videoPlayInterval);
                videoPlayInterval = null;
            }
            
            currentSubtitle.textContent = '';
            subtitleTimestamp.textContent = '';
            subtitleOverlay.style.display = 'none';
            currentSegmentIndex = -1;
            
            hideScrollButton();
            
            document.querySelectorAll('.segment').forEach(seg => {
                seg.classList.remove('highlighted');
            });
        }
        
        // Formatează timpul (secunde în HH:MM:SS)
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
        }
        
        function updateTranslationProgress(percent, text) {
            translationProgressFill.style.width = `${percent}%`;
            translationProgressText.textContent = text;
        }
        
        function downloadSRT() {
            if (!srtFilename || !processId) {
                showToast('Nu există fișier SRT pentru descărcare', 'error');
                return;
            }
            
            window.open(`/download/${processId}/${encodeURIComponent(srtFilename)}`, '_blank');
        }
        
        function downloadTranslatedSRT() {
            if (!translatedSrtFilename || !processId) {
                downloadSRT();
                return;
            }
            
            window.open(`/download/${processId}/${encodeURIComponent(translatedSrtFilename)}`, '_blank');
        }
        
        function playWithSubtitles() {
            if (videoPreviewContainer.style.display === 'none') {
                videoPreviewContainer.style.display = 'block';
            }
            playVideoWithSubtitles();
        }
        
        // Funcții pentru scroll manual
        function scrollToCurrentSegment() {
            if (currentSegmentIndex >= 0 && currentSegmentIndex < currentSegments.length) {
                const segments = document.querySelectorAll('.segment');
                if (segments[currentSegmentIndex]) {
                    segments[currentSegmentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        function hideScrollButton() {
            scrollToCurrentBtn.style.display = 'none';
        }
        
        function resetApp() {
            stopPlayback();
            
            selectedFile = null;
            srtFilename = '';
            translatedSrtFilename = '';
            processId = null;
            currentSegments = [];
            originalSegments = [];
            translatedSegments = [];
            previewSegments = [];
            videoPreviewUrl = null;
            imagePreviewUrl = null;
            isVideoFile = false;
            isMp4File = false;
            videoDuration = 0;
            videoPlaying = false;
            videoPlayInterval = null;
            currentSegmentIndex = -1;
            showTranslatedSegments = false;
            multipleTranslations = {};
            currentTranslationLang = null;
            
            // Reset upload segmentat
            chunkedUploadSession = null;
            uploadPaused = false;
            uploadCancelled = false;
            totalChunks = 0;
            uploadedChunks = 0;
            
            uploadText.textContent = 'Trage și plasează fișierul aici sau click pentru a selecta';
            processBtn.disabled = true;
            quickPreviewBtn.disabled = true;
            resultContainer.style.display = 'none';
            processingInfo.style.display = 'none';
            segmentsPreview.style.display = 'none';
            videoPreviewContainer.style.display = 'none';
            multipleTranslationsPanel.style.display = 'none';
            loading.style.display = 'none';
            progressContainer.style.display = 'none';
            translationProgress.style.display = 'none';
            loadingTranslationInfo.style.display = 'none';
            processingChunksInfo.style.display = 'none';
            formatInfo.style.display = 'none';
            sizeWarning.style.display = 'none';
            fallbackOptions.style.display = 'none';
            chunkedUploadProgress.style.display = 'none';
            hideError();
            hideScrollButton();
            
            toggleSegmentsTranslationBtn.innerHTML = '<i class="fas fa-language"></i> Afișează Traducerea';
            toggleSegmentsTranslationBtn.classList.remove('active');
            toggleSegmentsTranslationBtn.style.display = 'none';
            downloadTranslatedBtn.style.display = 'none';
            document.getElementById('audioOnlyResult').style.display = 'none';
            document.getElementById('transcriptionResult').style.display = 'block';
            document.getElementById('transcriptionButtons').style.display = 'flex';
            document.getElementById('resultTitle').innerHTML = '<i class="fas fa-check-circle"></i> Transcriere finalizată!';
            mainDownloadTranslatedBtn.style.display = 'none';
            showMultipleTranslationsBtn.style.display = 'inline-flex';
            
            videoPreview.src = '';
            videoPreview.style.display = 'none';
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            
            fileInput.value = '';
            
            currentSubtitle.textContent = '';
            subtitleTimestamp.textContent = '';
            subtitleOverlay.style.display = 'none';
            currentTimeElement.textContent = '00:00:00';
            totalTimeElement.textContent = '00:00:00';
            playVideoBtn.innerHTML = '<i class="fas fa-play"></i> Play cu Subtitrări';
            
            document.querySelectorAll('.segment').forEach(seg => {
                seg.classList.remove('highlighted');
            });
            
            translationsListContainer.innerHTML = '<p>Se încarcă traducerile existente...</p>';
            newTranslationSelect.value = '';
            
            showToast('Aplicație resetată', 'info');
        }
        
        function showError(message) {
            errorArea.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            errorArea.style.display = 'block';
        }
        
        function hideError() {
            errorArea.style.display = 'none';
        }
        
        function showToast(message, type = 'info') {
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            `;
            
            const icon = type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info';
            toast.innerHTML = `<i class="fas fa-${icon}-circle"></i> ${message}`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>